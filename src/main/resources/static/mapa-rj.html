<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Mapa do Rio de Janeiro</title>

    <!-- CSS do Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100vh;
        width: 100vw;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!-- JS do Leaflet -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // Centro padr√£o (Rio de Janeiro)
      const defaultLat = -22.9068;
      const defaultLon = -43.1729;
      const defaultRadius = 4000;

      const map = L.map("map").setView([defaultLat, defaultLon], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      const markersLayer = L.layerGroup().addTo(map);

      // √çcone vermelho customizado (parecido com o marker padr√£o do Leaflet)
      const userIcon = L.icon({
        iconUrl:
          "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
        shadowUrl:
          "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
        iconSize: [25, 41], // tamanho do √≠cone
        iconAnchor: [12, 41], // ponto do √≠cone que fica na coordenada
        popupAnchor: [1, -34], // onde o popup abre em rela√ß√£o ao √≠cone
        shadowSize: [41, 41],
      });

      // üî¥ Marker especial para localiza√ß√£o do usu√°rio / RJ padr√£o
      let userMarker = null;

      function setUserMarker(lat, lon, label) {
        console.log("userMarker vai pra:", lat, lon, "‚Üí", label);

        if (userMarker) {
          userMarker.setLatLng([lat, lon]);
          userMarker.setPopupContent(label);
        } else {
          userMarker = L.marker([lat, lon], { icon: userIcon })
            .addTo(map)
            .bindPopup(label);
        }
      }

      async function carregarPlaces(lat, lon, radius = defaultRadius) {
        try {
          const url = `/api/places?lat=${lat}&lon=${lon}&radius=${radius}`;
          console.log("Chamando:", url);

          const response = await fetch(url);
          if (!response.ok) {
            console.error("Erro ao chamar /api/places:", response.status);
            return;
          }

          const places = await response.json();
          console.log("Places recebidos:", places.length, places);

          markersLayer.clearLayers();

          if (!places.length) {
            console.warn("Nenhum place recebido da API");
            return;
          }

          places.forEach((place) => {
            const marker = L.marker([place.lat, place.lon]).addTo(markersLayer);
            marker.bindPopup(`
          <b>${place.name}</b><br/>
          Tipo: ${place.type}<br/>
          <button onclick="combinarRole(${place.id})">
            Combinar rol√™
          </button>
        `);
          });
        } catch (error) {
          console.error("Erro ao carregar places:", error);
        }
      }

      map.on("click", function (e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;

        console.log("Posi√ß√£o ajustada manualmente:", lat, lon);

        setUserMarker(lat, lon, "Posi√ß√£o ajustada por voc√™");
        carregarPlaces(lat, lon, defaultRadius);
      });

      function combinarRole(placeId) {
        alert("Combinar rol√™ no lugar ID " + placeId);
      }

      function inicializarMapa() {
        // Primeiro tenta GPS
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const userLat = pos.coords.latitude;
              const userLon = pos.coords.longitude;
              console.log("Localiza√ß√£o do usu√°rio:", userLat, userLon);

              // Centraliza no usu√°rio
              map.setView([userLat, userLon], 13);

              // üî¥ Marca a localiza√ß√£o do usu√°rio em vermelho
              setUserMarker(userLat, userLon, "Voc√™ est√° aqui");

              // Carrega lugares ao redor
              carregarPlaces(userLat, userLon, defaultRadius);
            },
            (err) => {
              console.warn(
                "N√£o foi poss√≠vel obter localiza√ß√£o do usu√°rio:",
                err.message
              );
              // fallback: usa Rio de Janeiro
              map.setView([defaultLat, defaultLon], 12);

              // üî¥ Marca o centro RJ como localiza√ß√£o padr√£o
              setUserMarker(
                defaultLat,
                defaultLon,
                "Local padr√£o: Centro do Rio"
              );

              carregarPlaces(defaultLat, defaultLon, defaultRadius);
            },
            {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0,
            }
          );
        } else {
          console.warn("Geolocaliza√ß√£o n√£o suportada no navegador");
          // fallback: Rio
          setUserMarker(defaultLat, defaultLon, "Local padr√£o: Centro do Rio");
          carregarPlaces(defaultLat, defaultLon, defaultRadius);
        }
      }

      // inicia tudo
      inicializarMapa();
    </script>
  </body>
</html>
