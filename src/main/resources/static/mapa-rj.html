<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Mapa do Rio de Janeiro</title>

    <!-- CSS do Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #020617;
        color: #e5e7eb;
      }

      .app-header {
        padding: 8px 12px;
        background: #020617;
        border-bottom: 1px solid #111827;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
      }

      .app-header .title {
        font-weight: 600;
      }

      .app-header .user {
        font-size: 0.8rem;
        color: #9ca3af;
      }

      #coords {
        position: absolute;
        top: 44px;
        left: 8px;
        background: rgba(15, 23, 42, 0.85);
        color: #e5e7eb;
        padding: 6px 8px;
        border-radius: 8px;
        font-size: 0.75rem;
        z-index: 1000;
      }

      #map {
        flex: 1;
        width: 100vw;
      }

      .bottom-nav {
        height: 56px;
        background: #020617;
        border-top: 1px solid #111827;
        display: flex;
        justify-content: space-around;
        align-items: center;
      }

      .bottom-nav button {
        flex: 1;
        height: 100%;
        border: none;
        background: transparent;
        color: #9ca3af;
        font-size: 0.75rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
        cursor: pointer;
      }

      .bottom-nav button span.icon {
        font-size: 1.1rem;
      }

      .bottom-nav button.active {
        color: #3b82f6;
        border-top: 2px solid #3b82f6;
      }

      @media (max-width: 480px) {
        .app-header {
          font-size: 0.8rem;
        }
        #coords {
          font-size: 0.7rem;
        }
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="title">JaVai</div>
      <div class="user">Online</div>
    </header>

    <div id="coords">Localiza√ß√£o: carregando...</div>

    <div id="map"></div>

    <nav class="bottom-nav">
      <button class="tab" data-tab="historico">
        <span class="icon">üïí</span>
        <span>Hist√≥rico</span>
      </button>
      <button class="tab" data-tab="grupos">
        <span class="icon">üë•</span>
        <span>Grupos</span>
      </button>
      <button class="tab active" data-tab="explorar">
        <span class="icon">üß≠</span>
        <span>Explorar</span>
      </button>
      <button class="tab" data-tab="recomendacoes">
        <span class="icon">‚ú®</span>
        <span>Recomenda√ß√µes</span>
      </button>
      <button class="tab" data-tab="conta">
        <span class="icon">‚öôÔ∏è</span>
        <span>Conta</span>
      </button>
    </nav>

    <!-- JS do Leaflet -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // --------- Tabs da barra inferior (ainda sem telas reais, s√≥ stub) ---------
      const tabs = document.querySelectorAll(".bottom-nav .tab");
      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");

          const name = tab.dataset.tab;
          if (name !== "explorar") {
            alert(
              'Aba "' +
                name +
                '" ainda n√£o implementada. Aqui depois entra a tela de ' +
                name +
                "."
            );
          }
        });
      });

      // Centro padr√£o (Rio de Janeiro)
      const defaultLat = -22.9068;
      const defaultLon = -43.1729;
      const defaultRadius = 1000;

      const map = L.map("map").setView([defaultLat, defaultLon], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      const markersLayer = L.layerGroup().addTo(map);

      const coordsDiv = document.getElementById("coords");

      function atualizarCoordsLabel(lat, lon, origem) {
        coordsDiv.textContent = `Localiza√ß√£o (${origem}): ${lat.toFixed(
          5
        )}, ${lon.toFixed(5)}`;
      }

      // √çcone vermelho customizado (parecido com o marker padr√£o do Leaflet)
      const userIcon = L.icon({
        iconUrl:
          "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
        shadowUrl:
          "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
        iconSize: [25, 41], // tamanho do √≠cone
        iconAnchor: [12, 41], // ponto do √≠cone que fica na coordenada
        popupAnchor: [1, -34], // onde o popup abre em rela√ß√£o ao √≠cone
        shadowSize: [41, 41],
      });

      // üî¥ Marker especial para localiza√ß√£o do usu√°rio / RJ padr√£o
      let userMarker = null;

      function setUserMarker(lat, lon, label) {
        console.log("userMarker vai pra:", lat, lon, "‚Üí", label);
        atualizarCoordsLabel(lat, lon, label);

        if (userMarker) {
          userMarker.setLatLng([lat, lon]);
          userMarker.setPopupContent(label);
        } else {
          userMarker = L.marker([lat, lon], { icon: userIcon })
            .addTo(map)
            .bindPopup(label);
        }
      }

      async function carregarPlaces(lat, lon, radius = defaultRadius) {
        try {
          const url = `/api/places?lat=${lat}&lon=${lon}&radius=${radius}`;
          console.log("Chamando:", url);

          const response = await fetch(url);
          if (!response.ok) {
            console.error("Erro ao chamar /api/places:", response.status);
            return;
          }

          const places = await response.json();
          console.log("Places recebidos:", places.length, places);

          markersLayer.clearLayers();

          if (!places.length) {
            console.warn("Nenhum place recebido da API");
            return;
          }

          places.forEach((place) => {
            const marker = L.marker([place.lat, place.lon]).addTo(markersLayer);
            marker.bindPopup(`
              <b>${place.name}</b><br/>
              Tipo: ${place.type}<br/>
              <button onclick="combinarRole(${place.id})">
                Combinar rol√™
              </button>
            `);
          });
        } catch (error) {
          console.error("Erro ao carregar places:", error);
        }
      }

      map.on("click", function (e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;

        console.log("Posi√ß√£o ajustada manualmente:", lat, lon);

        setUserMarker(lat, lon, "Posi√ß√£o ajustada por voc√™");
        carregarPlaces(lat, lon, defaultRadius);
      });

      function combinarRole(placeId) {
        alert(
          "Combinar rol√™ no lugar ID " +
            placeId +
            " (futuro: abrir fluxo de grupo/vota√ß√£o)"
        );
      }

      function inicializarMapa() {
        // Primeiro tenta GPS
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const userLat = pos.coords.latitude;
              const userLon = pos.coords.longitude;
              console.log("Localiza√ß√£o do usu√°rio:", userLat, userLon);

              map.setView([userLat, userLon], 13);

              setUserMarker(userLat, userLon, "Voc√™ est√° aqui");

              carregarPlaces(userLat, userLon, defaultRadius);
            },
            (err) => {
              console.warn(
                "N√£o foi poss√≠vel obter localiza√ß√£o do usu√°rio:",
                err.message
              );
              map.setView([defaultLat, defaultLon], 12);

              setUserMarker(
                defaultLat,
                defaultLon,
                "Local padr√£o: Centro do Rio"
              );

              carregarPlaces(defaultLat, defaultLon, defaultRadius);
            },
            {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0,
            }
          );
        } else {
          console.warn("Geolocaliza√ß√£o n√£o suportada no navegador");
          setUserMarker(defaultLat, defaultLon, "Local padr√£o: Centro do Rio");
          carregarPlaces(defaultLat, defaultLon, defaultRadius);
        }
      }

      // inicia tudo
      inicializarMapa();
    </script>
  </body>
</html>
