<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Mapa do Rio de Janeiro</title>

    <!-- CSS do Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #020617;
        color: #e5e7eb;
      }

      .app-header {
        padding: 8px 12px;
        background: #020617;
        border-bottom: 1px solid #111827;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
      }

      .app-header .title {
        font-weight: 600;
      }

      .app-header .user {
        font-size: 0.8rem;
        color: #9ca3af;
      }

      #coords {
        position: absolute;
        top: 44px;
        left: 8px;
        background: rgba(15, 23, 42, 0.85);
        color: #e5e7eb;
        padding: 6px 8px;
        border-radius: 8px;
        font-size: 0.75rem;
        z-index: 1000;
      }

      #map {
        flex: 1;
        width: 100vw;
      }

      .bottom-nav {
        height: 56px;
        background: #020617;
        border-top: 1px solid #111827;
        display: flex;
        justify-content: space-around;
        align-items: center;
      }

      .bottom-nav button {
        flex: 1;
        height: 100%;
        border: none;
        background: transparent;
        color: #9ca3af;
        font-size: 0.75rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
        cursor: pointer;
      }

      .bottom-nav button span.icon {
        font-size: 1.1rem;
      }

      .bottom-nav button.active {
        color: #3b82f6;
        border-top: 2px solid #3b82f6;
      }

      @media (max-width: 480px) {
        .app-header {
          font-size: 0.8rem;
        }
        #coords {
          font-size: 0.7rem;
        }
      }

      /* -------- Overlay + Card da Conta -------- */

      .account-overlay {
        position: fixed;
        inset: 0;
        /* fundo escuro por√©m transl√∫cido, deixando o mapa aparecer atr√°s */
        background: rgba(3, 7, 18, 0.45);
        backdrop-filter: blur(3px);
        display: none; /* controlado via JS */
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 16px;
      }

      .account-card {
        width: 100%;
        max-width: 420px;
        background: radial-gradient(
            circle at top right,
            rgba(59, 130, 246, 0.16),
            transparent 55%
          ),
          radial-gradient(
            circle at bottom left,
            rgba(56, 189, 248, 0.12),
            transparent 60%
          ),
          #020617;
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        box-shadow: 0 28px 60px rgba(15, 23, 42, 0.9),
          0 0 0 1px rgba(15, 23, 42, 0.8);
        padding: 18px 18px 14px;
        color: #e5e7eb;
        position: relative;
        overflow: hidden;
      }

      .account-card::before {
        content: "";
        position: absolute;
        inset: -40%;
        background: radial-gradient(
          circle at 0 0,
          rgba(96, 165, 250, 0.18),
          transparent 55%
        );
        opacity: 0.7;
        pointer-events: none;
        mix-blend-mode: screen;
      }

      .account-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        position: relative;
        z-index: 1;
      }

      .account-card-header h3 {
        margin: 0;
        font-size: 1.1rem;
        letter-spacing: 0.02em;
      }

      .account-card-header span.sub {
        display: block;
        font-size: 0.76rem;
        color: #9ca3af;
        margin-top: 2px;
      }

      .account-panel-close {
        border: none;
        background: rgba(15, 23, 42, 0.8);
        color: #9ca3af;
        cursor: pointer;
        font-size: 1.1rem;
        width: 28px;
        height: 28px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .account-panel-close:hover {
        background: rgba(248, 113, 113, 0.12);
        color: #fecaca;
      }

      .account-profile {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
        position: relative;
        z-index: 1;
      }

      .avatar-circle {
        width: 52px;
        height: 52px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 30% 20%, #38bdf8, #1d4ed8);
        color: #e5e7eb;
        font-weight: 700;
        font-size: 1.4rem;
        box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.9);
      }

      .profile-main {
        flex: 1;
      }

      .profile-main .name {
        font-size: 1rem;
        font-weight: 600;
      }

      .profile-main .email {
        font-size: 0.8rem;
        color: #cbd5f5;
        word-break: break-all;
      }

      .profile-tags {
        margin-top: 6px;
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .chip {
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 0.7rem;
        border: 1px solid rgba(148, 163, 184, 0.4);
        color: #9ca3af;
        background: rgba(15, 23, 42, 0.85);
      }

      .account-sections {
        margin-top: 6px;
        position: relative;
        z-index: 1;
      }

      .account-section {
        margin-bottom: 10px;
        padding: 8px 10px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.92);
        border: 1px solid rgba(31, 41, 55, 0.9);
      }

      .account-section h4 {
        margin: 0 0 6px;
        font-size: 0.86rem;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        color: #9ca3af;
      }

      .list-compact {
        list-style: none;
        margin: 0;
        padding: 0;
        font-size: 0.8rem;
      }

      .list-compact li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        border-bottom: 1px solid rgba(31, 41, 55, 0.7);
      }

      .list-compact li:last-child {
        border-bottom: none;
      }

      .list-compact span.label {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .pill {
        font-size: 0.68rem;
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(37, 99, 235, 0.18);
        color: #bfdbfe;
      }

      .pill-secondary {
        background: rgba(55, 65, 81, 0.8);
        color: #e5e7eb;
      }

      @media (max-width: 480px) {
        .account-card {
          padding: 16px 14px 12px;
        }
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="title">Rol√™s</div>
      <div class="user">Online</div>
    </header>

    <div id="coords">Localiza√ß√£o: carregando...</div>

    <div id="map"></div>

    <!-- Overlay da Conta -->
    <div id="account-panel" class="account-overlay" style="display: none">
      <div class="account-card" id="account-card">
        <div class="account-card-header">
          <div>
            <h3>Sua conta</h3>
            <span class="sub">Configura√ß√µes e hist√≥rico do seu rol√™</span>
          </div>
          <button
            class="account-panel-close"
            id="close-account-panel"
            aria-label="Fechar"
          >
            ‚úï
          </button>
        </div>

        <div class="account-profile">
          <div class="avatar-circle" id="account-avatar">?</div>
          <div class="profile-main">
            <div class="name" id="account-name">Carregando...</div>
            <div class="email" id="account-email">‚Äî</div>
            <div class="profile-tags">
              <span class="chip">Usu√°rio ativo</span>
              <span class="chip">Explorador de rol√™s</span>
            </div>
          </div>
        </div>

        <div class="account-sections">
          <div class="account-section">
            <h4>Hist√≥rico de rol√™s</h4>
            <ul class="list-compact" id="roles-list">
              <!-- preenchido via JS -->
            </ul>
          </div>

          <div class="account-section">
            <h4>Lista de amigos</h4>
            <ul class="list-compact" id="friends-list">
              <!-- preenchido via JS -->
            </ul>
          </div>
        </div>
      </div>
    </div>

    <nav class="bottom-nav">
      <button class="tab" data-tab="historico">
        <span class="icon">üïí</span>
        <span>Hist√≥rico</span>
      </button>
      <button class="tab" data-tab="grupos">
        <span class="icon">üë•</span>
        <span>Grupos</span>
      </button>
      <button class="tab active" data-tab="explorar">
        <span class="icon">üß≠</span>
        <span>Explorar</span>
      </button>
      <button class="tab" data-tab="recomendacoes">
        <span class="icon">‚ú®</span>
        <span>Recomenda√ß√µes</span>
      </button>
      <button class="tab" data-tab="conta">
        <span class="icon">‚öôÔ∏è</span>
        <span>Conta</span>
      </button>
    </nav>

    <!-- JS do Leaflet -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // -------- Overlay da Conta / UI --------

      const accountPanel = document.getElementById("account-panel");
      const accountCard = document.getElementById("account-card");
      const closeAccountBtn = document.getElementById("close-account-panel");
      const accountNameEl = document.getElementById("account-name");
      const accountEmailEl = document.getElementById("account-email");
      const accountAvatarEl = document.getElementById("account-avatar");
      const rolesListEl = document.getElementById("roles-list");
      const friendsListEl = document.getElementById("friends-list");

      const mockRoles = [
        {
          nome: "Bar da Lapa",
          data: "05/11",
          status: "Conclu√≠do",
        },
        {
          nome: "Pedal na Lagoa",
          data: "28/10",
          status: "Confirmado",
        },
        {
          nome: "Praia em Ipanema",
          data: "20/10",
          status: "Finalizado",
        },
      ];

      const mockFriends = [
        { nome: "Ana", tag: "@ana_rol√™s" },
        { nome: "Bruno", tag: "@bruno.bike" },
        { nome: "Carla", tag: "@carla.sunset" },
      ];

      function initialsFromName(name) {
        if (!name) return "?";
        const parts = name.trim().split(/\s+/);
        if (parts.length === 1) {
          return parts[0].charAt(0).toUpperCase();
        }
        return (
          parts[0].charAt(0).toUpperCase() +
          parts[parts.length - 1].charAt(0).toUpperCase()
        );
      }

      function renderMockRoles() {
        rolesListEl.innerHTML = "";
        mockRoles.forEach((role) => {
          const li = document.createElement("li");
          const left = document.createElement("span");
          left.className = "label";
          left.textContent = role.nome;

          const right = document.createElement("span");
          right.className = "pill";
          right.textContent = `${role.data} ‚Ä¢ ${role.status}`;

          li.appendChild(left);
          li.appendChild(right);
          rolesListEl.appendChild(li);
        });
      }

      function renderMockFriends() {
        friendsListEl.innerHTML = "";
        mockFriends.forEach((f) => {
          const li = document.createElement("li");
          const left = document.createElement("span");
          left.className = "label";
          left.textContent = f.nome;

          const right = document.createElement("span");
          right.className = "pill pill-secondary";
          right.textContent = f.tag;

          li.appendChild(left);
          li.appendChild(right);
          friendsListEl.appendChild(li);
        });
      }

      async function abrirPainelConta() {
        accountPanel.style.display = "flex";

        accountNameEl.textContent = "Carregando...";
        accountEmailEl.textContent = "‚Äî";
        accountAvatarEl.textContent = "?";

        try {
          const resp = await fetch("/api/me");
          if (!resp.ok) {
            accountNameEl.textContent = "N√£o foi poss√≠vel carregar seus dados";
            accountEmailEl.textContent = `Status: ${resp.status}`;
            return;
          }

          const user = await resp.json();
          accountNameEl.textContent = user.nome ?? "Usu√°rio sem nome";
          accountEmailEl.textContent = user.email ?? "‚Äî";
          accountAvatarEl.textContent = initialsFromName(
            user.nome ?? user.email
          );
        } catch (e) {
          console.error("Erro ao carregar /api/me:", e);
          accountNameEl.textContent = "Erro ao carregar suas informa√ß√µes";
          accountEmailEl.textContent = "Tente novamente mais tarde.";
        }

        renderMockRoles();
        renderMockFriends();
      }

      function fecharPainelConta() {
        accountPanel.style.display = "none";
      }

      closeAccountBtn.addEventListener("click", () => {
        fecharPainelConta();
      });

      // fecha ao clicar fora do card
      accountPanel.addEventListener("click", (e) => {
        if (e.target === accountPanel) {
          fecharPainelConta();
        }
      });

      // -------- Tabs da barra inferior --------

      const tabs = document.querySelectorAll(".bottom-nav .tab");

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");

          const name = tab.dataset.tab;

          if (name === "conta") {
            abrirPainelConta();
          } else {
            fecharPainelConta();

            if (name !== "explorar") {
              alert(
                'Aba "' +
                  name +
                  '" ainda n√£o implementada. Aqui depois entra a tela de ' +
                  name +
                  "."
              );
            }
          }
        });
      });

      // -------- Mapa + OSM / Overpass --------

      const defaultLat = -22.9068;
      const defaultLon = -43.1729;
      const defaultRadius = 1000;

      const map = L.map("map").setView([defaultLat, defaultLon], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      const markersLayer = L.layerGroup().addTo(map);
      const coordsDiv = document.getElementById("coords");

      function atualizarCoordsLabel(lat, lon, origem) {
        coordsDiv.textContent = `Localiza√ß√£o (${origem}): ${lat.toFixed(
          5
        )}, ${lon.toFixed(5)}`;
      }

      const userIcon = L.icon({
        iconUrl:
          "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
        shadowUrl:
          "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41],
      });

      let userMarker = null;

      function setUserMarker(lat, lon, label) {
        console.log("userMarker vai pra:", lat, lon, "‚Üí", label);
        atualizarCoordsLabel(lat, lon, label);

        if (userMarker) {
          userMarker.setLatLng([lat, lon]);
          userMarker.setPopupContent(label);
        } else {
          userMarker = L.marker([lat, lon], { icon: userIcon })
            .addTo(map)
            .bindPopup(label);
        }
      }

      async function carregarPlaces(lat, lon, radius = defaultRadius) {
        try {
          const url = `/api/places?lat=${lat}&lon=${lon}&radius=${radius}`;
          console.log("Chamando:", url);

          const response = await fetch(url);
          if (!response.ok) {
            console.error("Erro ao chamar /api/places:", response.status);
            return;
          }

          const places = await response.json();
          console.log("Places recebidos:", places.length, places);

          markersLayer.clearLayers();

          if (!places.length) {
            console.warn("Nenhum place recebido da API");
            return;
          }

          places.forEach((place) => {
            const marker = L.marker([place.lat, place.lon]).addTo(markersLayer);
            marker.bindPopup(`
              <b>${place.name}</b><br/>
              Tipo: ${place.type}<br/>
              <button onclick="combinarRole(${place.id})">
                Combinar rol√™
              </button>
            `);
          });
        } catch (error) {
          console.error("Erro ao carregar places:", error);
        }
      }

      map.on("click", function (e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;

        console.log("Posi√ß√£o ajustada manualmente:", lat, lon);

        setUserMarker(lat, lon, "Posi√ß√£o ajustada por voc√™");
        carregarPlaces(lat, lon, defaultRadius);
      });

      function combinarRole(placeId) {
        alert(
          "Combinar rol√™ no lugar ID " +
            placeId +
            " (futuro: abrir fluxo de grupo/vota√ß√£o)"
        );
      }

      function inicializarMapa() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const userLat = pos.coords.latitude;
              const userLon = pos.coords.longitude;
              console.log("Localiza√ß√£o do usu√°rio:", userLat, userLon);

              map.setView([userLat, userLon], 13);

              setUserMarker(userLat, userLon, "Voc√™ est√° aqui");

              carregarPlaces(userLat, userLon, defaultRadius);
            },
            (err) => {
              console.warn(
                "N√£o foi poss√≠vel obter localiza√ß√£o do usu√°rio:",
                err.message
              );
              map.setView([defaultLat, defaultLon], 12);

              setUserMarker(
                defaultLat,
                defaultLon,
                "Local padr√£o: Centro do Rio"
              );

              carregarPlaces(defaultLat, defaultLon, defaultRadius);
            },
            {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0,
            }
          );
        } else {
          console.warn("Geolocaliza√ß√£o n√£o suportada no navegador");
          setUserMarker(defaultLat, defaultLon, "Local padr√£o: Centro do Rio");
          carregarPlaces(defaultLat, defaultLon, defaultRadius);
        }
      }

      inicializarMapa();
    </script>
  </body>
</html>
