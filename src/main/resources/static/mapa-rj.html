<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Mapa do Rio de Janeiro</title>

    <!-- CSS do Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      :root {
        --panel-bg: rgba(15, 23, 42, 0.85);
        --main-text: #e5e7eb;
        --border-color: #111827;
        --blue: #3b82f6;
        --dark-blue: #1d4ed8;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #020617;
        color: var(--main-text);
      }

      .app-header {
        padding: 8px 12px;
        background: #020617;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1001; /* Acima dos paineis */
      }

      .app-header .title { font-weight: 600; }
      .app-header .user { font-size: 0.8rem; color: #9ca3af; }

      #map {
        flex: 1;
        width: 100vw;
      }

      /* Painel de Coordenadas (movido para baixo) */
      #coords {
        position: absolute;
        bottom: 64px; /* Acima da barra de navega√ß√£o */
        left: 8px;
        background: var(--panel-bg);
        padding: 6px 8px;
        border-radius: 8px;
        font-size: 0.75rem;
        z-index: 1000;
        max-width: 300px;
      }

      /* Painel de Filtro de Categorias */
      #category-filter {
        position: absolute;
        top: 44px;
        left: 8px;
        background: var(--panel-bg);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        z-index: 1000;
        max-height: 50vh;
        max-width: 200px;
        overflow-y: auto;
      }
      #category-filter h4 {
        margin: 0 0 8px 0;
        font-size: 0.85rem;
        border-bottom: 1px solid #334155;
        padding-bottom: 4px;
      }
      .category-item {
        display: block;
        margin-bottom: 5px;
      }
      .category-item label {
        cursor: pointer;
        user-select: none;
        margin-left: 4px;
      }
      .category-item input {
        cursor: pointer;
      }

      /* Loader para categorias */
      .loader {
        font-size: 0.75rem;
        color: #9ca3af;
      }

      .bottom-nav {
        height: 56px;
        background: #020617;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-around;
        align-items: center;
      }

      .bottom-nav button {
        flex: 1;
        height: 100%;
        border: none;
        background: transparent;
        color: #9ca3af;
        font-size: 0.75rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
        cursor: pointer;
      }

      .bottom-nav button span.icon {
        font-size: 1.2rem;
      }

      .bottom-nav button.active {
        color: #3b82f6;
        border-top: 2px solid #3b82f6;
      }

      @media (max-width: 480px) {
        .app-header { font-size: 0.8rem; }
        #coords { font-size: 0.7rem; bottom: 60px; }
        #category-filter { font-size: 0.75rem; padding: 6px 8px; }
      }

      /* -------- Overlay + Card da Conta -------- */

      .account-overlay {
        position: fixed;
        inset: 0;
        /* fundo escuro por√©m transl√∫cido, deixando o mapa aparecer atr√°s */
        background: rgba(3, 7, 18, 0.45);
        backdrop-filter: blur(3px);
        display: none; /* controlado via JS */
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 16px;
      }

      .account-card {
        width: 100%;
        max-width: 420px;
        background: radial-gradient(
            circle at top right,
            rgba(59, 130, 246, 0.16),
            transparent 55%
          ),
          radial-gradient(
            circle at bottom left,
            rgba(56, 189, 248, 0.12),
            transparent 60%
          ),
          #020617;
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        box-shadow: 0 28px 60px rgba(15, 23, 42, 0.9),
          0 0 0 1px rgba(15, 23, 42, 0.8);
        padding: 18px 18px 14px;
        color: #e5e7eb;
        position: relative;
        overflow: hidden;
      }

      .account-card::before {
        content: "";
        position: absolute;
        inset: -40%;
        background: radial-gradient(
          circle at 0 0,
          rgba(96, 165, 250, 0.18),
          transparent 55%
        );
        opacity: 0.7;
        pointer-events: none;
        mix-blend-mode: screen;
      }

      .account-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        position: relative;
        z-index: 1;
      }

      .account-card-header h3 {
        margin: 0;
        font-size: 1.1rem;
        letter-spacing: 0.02em;
      }

      .account-card-header span.sub {
        display: block;
        font-size: 0.76rem;
        color: #9ca3af;
        margin-top: 2px;
      }

      .account-panel-close {
        border: none;
        background: rgba(15, 23, 42, 0.8);
        color: #9ca3af;
        cursor: pointer;
        font-size: 1.1rem;
        width: 28px;
        height: 28px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .account-panel-close:hover {
        background: rgba(248, 113, 113, 0.12);
        color: #fecaca;
      }

      .account-profile {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
        position: relative;
        z-index: 1;
      }
      .name-row {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .name-row .name {
        font-size: 1rem;
        font-weight: 600;
      }

      .edit-icon {
        border: none;
        background: transparent;
        color: #9ca3af;
      /* Bot√£o customizado para o Leaflet */
      .leaflet-control-custom {
        background-color: white;
        border: 2px solid rgba(0, 0, 0, 0.2);
        background-clip: padding-box;
        border-radius: 4px;
        width: 34px !important;
        height: 34px !important;
        text-align: center;
        line-height: 30px;
        font-size: 1.2rem;
        cursor: pointer;
        font-size: 0.85rem;
        padding: 2px;
        border-radius: 999px;
      }

      .edit-icon:hover {
        background: rgba(148, 163, 184, 0.15);
        color: #e5e7eb;
      }

      .name-edit {
        margin-top: 6px;
        display: flex;
        gap: 6px;
      }

      .name-edit input {
        flex: 1;
        padding: 4px 6px;
        border-radius: 8px;
        border: 1px solid #4b5563;
        background: #020617;
        color: #e5e7eb;
        font-size: 0.85rem;
      }

      .name-edit input:focus {
        outline: none;
        border-color: #3b82f6;
      }

      .name-edit button {
        padding: 4px 8px;
        border-radius: 999px;
        border: none;
        font-size: 0.78rem;
        cursor: pointer;
      }

      #name-save-btn {
        background: #3b82f6;
        color: #e5e7eb;
      }

      #name-save-btn:hover {
        background: #2563eb;
      }

      #name-cancel-btn {
        background: #111827;
        color: #e5e7eb;
      }

      #name-cancel-btn:hover {
        background: #1f2937;
      }

      /* utilit√°ria pra esconder blocos */
      .hidden {
        display: none;
      }

      .avatar-circle {
        width: 52px;
        height: 52px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        /* gradiente padr√£o quando n√£o tem foto */
        background: radial-gradient(circle at 30% 20%, #38bdf8, #1d4ed8);
        color: #e5e7eb;
        font-weight: 700;
        font-size: 1.4rem;
        box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.9);
        cursor: pointer; /* üëà indica que √© clic√°vel */
        overflow: hidden; /* corta bordas da imagem */
        background-size: cover; /* imagem cobre o c√≠rculo */
        background-position: center; /* centraliza a imagem */
      }

      .profile-main {
        flex: 1;
      }

      .profile-main .name {
        font-size: 1rem;
        font-weight: 600;
      }

      .profile-main .email {
        font-size: 0.8rem;
        color: #cbd5f5;
        word-break: break-all;
      }

      .profile-tags {
        margin-top: 6px;
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .chip {
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 0.7rem;
        border: 1px solid rgba(148, 163, 184, 0.4);
        color: #9ca3af;
        background: rgba(15, 23, 42, 0.85);
      }

      .account-sections {
        margin-top: 6px;
        position: relative;
        z-index: 1;
      }

      .account-section {
        margin-bottom: 10px;
        padding: 8px 10px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.92);
        border: 1px solid rgba(31, 41, 55, 0.9);
      }

      .account-section h4 {
        margin: 0 0 6px;
        font-size: 0.86rem;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        color: #9ca3af;
      }

      .list-compact {
        list-style: none;
        margin: 0;
        padding: 0;
        font-size: 0.8rem;
      }

      .list-compact li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        border-bottom: 1px solid rgba(31, 41, 55, 0.7);
      }

      .list-compact li:last-child {
        border-bottom: none;
      }

      .list-compact span.label {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .pill {
        font-size: 0.68rem;
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(37, 99, 235, 0.18);
        color: #bfdbfe;
      }

      .pill-secondary {
        background: rgba(55, 65, 81, 0.8);
        color: #e5e7eb;
      }

      @media (max-width: 480px) {
        .account-card {
          padding: 16px 14px 12px;
        }
      /* √çcone de c√≠rculo azul para a localiza√ß√£o real do usu√°rio */
      .blue-circle-icon div {
        width: 16px;
        height: 16px;
        background-color: var(--blue);
        border: 2px solid var(--dark-blue);
        border-radius: 50%;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.5);
      }

      /* -------- Overlay do Chat (mapa ao fundo, estilo Telegram) -------- */

      .overlay-chat {
        position: fixed;
        inset: 0;
        background: rgba(3, 7, 18, 0.45); /* mapa aparece atr√°s */
        backdrop-filter: blur(4px);
        display: none; /* controlado via JS */
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 16px;
      }

      /* container principal do chat */
      .chat-app-container {
        width: min(100%, 960px);
        height: min(80vh, 620px);
        background: #020617;
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 24px 60px rgba(15, 23, 42, 0.85),
          0 0 0 1px rgba(15, 23, 42, 0.9);
        display: flex;
        border: 1px solid rgba(148, 163, 184, 0.35);
      }

      /* SIDEBAR (lista de amigos) */

      .sidebar {
        width: 30%;
        min-width: 230px;
        background: #020617;
        border-right: 1px solid #111827;
        display: flex;
        flex-direction: column;
      }

      .sidebar-header {
        padding: 10px 12px;
        border-bottom: 1px solid #111827;
      }

      .sidebar-header h3 {
        margin: 0 0 6px;
        font-size: 0.9rem;
        color: #e5e7eb;
      }

      .sidebar-header input {
        width: 100%;
        padding: 6px 8px;
        border-radius: 999px;
        border: 1px solid #4b5563;
        background: #020617;
        color: #e5e7eb;
        font-size: 0.8rem;
      }

      .sidebar-header input::placeholder {
        color: #6b7280;
      }

      .sidebar-header input:focus {
        outline: none;
        border-color: #3b82f6;
      }

      .contact-list {
        list-style: none;
        padding: 4px 0;
        margin: 0;
        overflow-y: auto;
        flex: 1;
      }

      .contact-item {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        cursor: pointer;
        gap: 10px;
        font-size: 0.85rem;
        color: #e5e7eb;
        transition: background 0.2s ease;
      }

      .contact-item:hover {
        background: rgba(15, 23, 42, 0.85);
      }

      .contact-item.active {
        background: rgba(37, 99, 235, 0.18);
      }

      .contact-avatar {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        background: linear-gradient(135deg, #3b82f6, #06b6d4);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        color: #e5e7eb;
      }

      /* √ÅREA PRINCIPAL DO CHAT */

      .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #020617;
      }

      .chat-header {
        padding: 10px 12px;
        border-bottom: 1px solid #111827;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .chat-header-left {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .chat-title {
        font-size: 0.9rem;
        font-weight: 600;
      }

      .chat-subtitle {
        font-size: 0.7rem;
        color: #9ca3af;
      }

      .chat-close-btn {
        border: none;
        background: rgba(15, 23, 42, 0.9);
        color: #9ca3af;
        cursor: pointer;
        font-size: 1rem;
        width: 26px;
        height: 26px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chat-close-btn:hover {
        background: rgba(148, 163, 184, 0.25);
        color: #e5e7eb;
      }

      /* Mensagens */

      .messages-container {
        flex: 1;
        padding: 12px 12px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 0.8rem;
      }

      .message-row {
        display: flex;
      }

      .message-row.me {
        justify-content: flex-end;
      }

      .message-row.other {
        justify-content: flex-start;
      }

      .message-bubble {
        max-width: 68%;
        padding: 7px 10px;
        border-radius: 14px;
        line-height: 1.4;
        word-wrap: break-word;
      }

      .message-row.me .message-bubble {
        background: #3b82f6;
        color: #e5e7eb;
        border-bottom-right-radius: 4px;
      }

      .message-row.other .message-bubble {
        background: #111827;
        color: #e5e7eb;
        border-bottom-left-radius: 4px;
        border: 1px solid #1f2937;
      }

      .message-meta {
        display: block;
        font-size: 0.65rem;
        color: #9ca3af;
        margin-top: 2px;
      }

      /* Input */

      .input-area {
        padding: 10px 12px;
        border-top: 1px solid #111827;
        display: flex;
        gap: 8px;
        background: #020617;
      }

      .input-area input {
        flex: 1;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid #4b5563;
        background: #020617;
        color: #e5e7eb;
        font-size: 0.8rem;
      }

      .input-area input::placeholder {
        color: #6b7280;
      }

      .input-area input:focus {
        outline: none;
        border-color: #3b82f6;
      }

      .input-area button {
        padding: 0 12px;
        border-radius: 999px;
        border: none;
        background: #3b82f6;
        color: #e5e7eb;
        cursor: pointer;
        font-size: 0.8rem;
      }

      .input-area button:hover {
        background: #2563eb;
      }

      /* Responsivo */

      @media (max-width: 768px) {
        .chat-app-container {
          width: 100%;
          height: 80vh;
          border-radius: 16px;
        }

        .sidebar {
          width: 38%;
          min-width: 0;
        }

        .message-bubble {
          max-width: 80%;
        }
      }

      @media (max-width: 540px) {
        .chat-app-container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid #111827;
        }
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="title">Rol√™s</div>
      <div class="user">Online</div>
    </header>

    <div id="category-filter"></div>
    <div id="coords">Localiza√ß√£o: carregando...</div>

    <div id="map"></div>

    <!-- Overlay da Conta -->
    <div id="account-panel" class="account-overlay" style="display: none">
      <div class="account-card" id="account-card">
        <div class="account-card-header">
          <div>
            <h3>Sua conta</h3>
            <span class="sub">Configura√ß√µes e hist√≥rico do seu rol√™</span>
          </div>
          <button
            class="account-panel-close"
            id="close-account-panel"
            aria-label="Fechar"
          >
            ‚úï
          </button>
        </div>

        <div class="account-profile">
          <div
            class="avatar-circle"
            id="account-avatar"
            title="Clique para alterar sua foto"
          >
            ?
          </div>

          <!-- input de arquivo escondido -->
          <input
            type="file"
            id="avatar-input"
            accept="image/*"
            style="display: none"
          />

          <div class="profile-main">
            <div class="name-row">
              <span class="name" id="account-name">Carregando...</span>
              <button
                type="button"
                class="edit-icon"
                id="edit-name-btn"
                title="Editar nome"
              >
                ‚úèÔ∏è
              </button>
            </div>

            <!-- modo edi√ß√£o do nome -->
            <div class="name-edit hidden" id="name-edit-container">
              <input
                type="text"
                id="name-edit-input"
                maxlength="60"
                placeholder="Digite seu nome"
              />
              <button type="button" id="name-save-btn">Salvar</button>
              <button type="button" id="name-cancel-btn">Cancelar</button>
            </div>

            <div class="email" id="account-email">‚Äî</div>
            <div class="profile-tags">
              <span class="chip">Usu√°rio ativo</span>
              <span class="chip">Explorador de rol√™s</span>
            </div>
          </div>
        </div>

        <div class="account-sections">
          <div class="account-section">
            <h4>Hist√≥rico de rol√™s</h4>
            <ul class="list-compact" id="roles-list">
              <!-- preenchido via JS -->
            </ul>
          </div>

          <div class="account-section">
            <h4>Lista de amigos</h4>
            <ul class="list-compact" id="friends-list">
              <!-- preenchido via JS -->
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Overlay do CHAT -->
    <div id="chat-overlay" class="overlay-chat">
      <div class="chat-app-container" id="chat-app-container">
        <!-- SIDEBAR: lista de amigos -->
        <aside class="sidebar">
          <div class="sidebar-header">
            <h3>Amigos</h3>
            <input
              type="text"
              id="contact-search"
              placeholder="Buscar pelo nome..."
            />
          </div>
          <ul class="contact-list" id="contact-list">
            <!-- preenchida via JS -->
          </ul>
        </aside>

        <!-- √ÅREA DO CHAT -->
        <section class="chat-area">
          <header class="chat-header">
            <div class="chat-header-left">
              <div class="chat-title" id="chat-header-title">
                Selecione um amigo
              </div>
              <div class="chat-subtitle" id="chat-header-subtitle">
                A conversa aparece aqui
              </div>
            </div>
            <button
              class="chat-close-btn"
              id="chat-close-btn"
              aria-label="Fechar chat"
            >
              ‚úï
            </button>
          </header>

          <div class="messages-container" id="messages-container">
            <!-- mensagens do contato selecionado -->
          </div>

          <div class="input-area">
            <input
              type="text"
              id="chat-input"
              placeholder="Digite uma mensagem..."
            />
            <button type="button" id="chat-send-button">Enviar</button>
          </div>
        </section>
      </div>
    </div>

    <nav class="bottom-nav">
      <button class="tab" data-tab="conta">
        <span class="icon">‚öôÔ∏è</span>
        <span>Conta</span>
      </button>
      <button class="tab active" data-tab="explorar">
        <span class="icon">üß≠</span>
        <span>Explorar</span>
      </button>
      <button class="tab" data-tab="chat">
        <span class="icon">üí¨</span>
        <span>Chat</span>
      </button>
    </nav>

    <!-- JS do Leaflet -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="js/traducoes.js" defer></script>

    <script>
      // -------- Overlay da Conta / UI --------

      const accountPanel = document.getElementById("account-panel");
      const accountCard = document.getElementById("account-card");
      const closeAccountBtn = document.getElementById("close-account-panel");
      const accountNameEl = document.getElementById("account-name");
      const accountEmailEl = document.getElementById("account-email");
      const accountAvatarEl = document.getElementById("account-avatar");
      const avatarInputEl = document.getElementById("avatar-input");
      const rolesListEl = document.getElementById("roles-list");
      const friendsListEl = document.getElementById("friends-list");
      const editNameBtn = document.getElementById("edit-name-btn");
      const nameEditContainer = document.getElementById("name-edit-container");
      const nameEditInput = document.getElementById("name-edit-input");
      const nameSaveBtn = document.getElementById("name-save-btn");
      const nameCancelBtn = document.getElementById("name-cancel-btn");

      let avatarCustomizado = false;

      const mockRoles = [
        {
          nome: "Bar da Lapa",
          data: "05/11",
          status: "Conclu√≠do",
        },
        {
          nome: "Pedal na Lagoa",
          data: "28/10",
          status: "Confirmado",
        },
        {
          nome: "Praia em Ipanema",
          data: "20/10",
          status: "Finalizado",
        },
      ];

      const mockFriends = [
        { nome: "Ana", tag: "@ana_rol√™s" },
        { nome: "Bruno", tag: "@bruno.bike" },
        { nome: "Carla", tag: "@carla.sunset" },
      ];

      function initialsFromName(name) {
        if (!name) return "?";
        const parts = name.trim().split(/\s+/);
        if (parts.length === 1) {
          return parts[0].charAt(0).toUpperCase();
        }
        return (
          parts[0].charAt(0).toUpperCase() +
          parts[parts.length - 1].charAt(0).toUpperCase()
        );
      }
      // clique no avatar abre seletor de arquivo
      accountAvatarEl.addEventListener("click", () => {
        avatarInputEl.click();
      });

      // quando o usu√°rio escolhe uma imagem
      avatarInputEl.addEventListener("change", () => {
        const file = avatarInputEl.files[0];
        if (!file) return;

        // opcional: limitar tamanho/tipo
        if (!file.type.startsWith("image/")) {
          alert("Por favor, selecione uma imagem v√°lida.");
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          const dataUrl = e.target.result;
          accountAvatarEl.style.backgroundImage = `url('${dataUrl}')`;
          accountAvatarEl.textContent = "";
          avatarCustomizado = true; // üëà marca que agora √© foto, n√£o iniciais
        };
        reader.readAsDataURL(file);

        const formData = new FormData();
        formData.append("avatar", file);

        fetch("/api/me/avatar", {
          method: "POST",
          body: formData,
        })
          .then((resp) => {
            if (!resp.ok) {
              console.error("Falha ao enviar avatar:", resp.status);
              // opcional: mostrar toast msg
            }
          })
          .catch((err) => {
            console.error("Erro na requisi√ß√£o de avatar:", err);
          });
      });

      function renderMockRoles() {
        rolesListEl.innerHTML = "";
        mockRoles.forEach((role) => {
          const li = document.createElement("li");
          const left = document.createElement("span");
          left.className = "label";
          left.textContent = role.nome;

          const right = document.createElement("span");
          right.className = "pill";
          right.textContent = `${role.data} ‚Ä¢ ${role.status}`;

          li.appendChild(left);
          li.appendChild(right);
          rolesListEl.appendChild(li);
        });
      }

      function renderMockFriends() {
        friendsListEl.innerHTML = "";
        mockFriends.forEach((f) => {
          const li = document.createElement("li");
          const left = document.createElement("span");
          left.className = "label";
          left.textContent = f.nome;

          const right = document.createElement("span");
          right.className = "pill pill-secondary";
          right.textContent = f.tag;

          li.appendChild(left);
          li.appendChild(right);
          friendsListEl.appendChild(li);
        });
      }

      async function abrirPainelConta() {
        accountPanel.style.display = "flex";

        accountNameEl.textContent = "Carregando...";
        accountEmailEl.textContent = "‚Äî";

        // se ainda n√£o foi customizado, mostra "?"
        if (!avatarCustomizado) {
          accountAvatarEl.textContent = "?";
          accountAvatarEl.style.backgroundImage = ""; // gradiente padr√£o do CSS
        }

        try {
          const resp = await fetch("/api/me");
          if (!resp.ok) {
            accountNameEl.textContent = "N√£o foi poss√≠vel carregar seus dados";
            accountEmailEl.textContent = `Status: ${resp.status}`;
            return;
          }

          const user = await resp.json();
          accountNameEl.textContent = user.nome ?? "Usu√°rio sem nome";
          accountEmailEl.textContent = user.email ?? "‚Äî";

          // üëâ S√≥ coloca iniciais se N√ÉO tiver foto customizada
          if (!avatarCustomizado) {
            accountAvatarEl.textContent = initialsFromName(
              user.nome ?? user.email
            );
            accountAvatarEl.style.backgroundImage = "";
          } else {
            // j√° tem foto, garante que o texto fique vazio
            accountAvatarEl.textContent = "";
          }
        } catch (e) {
          console.error("Erro ao carregar /api/me:", e);
          accountNameEl.textContent = "Erro ao carregar suas informa√ß√µes";
          accountEmailEl.textContent = "Tente novamente mais tarde.";
        }

        renderMockRoles();
        renderMockFriends();
      }

      function fecharPainelConta() {
        accountPanel.style.display = "none";
      }

      closeAccountBtn.addEventListener("click", () => {
        fecharPainelConta();
      });

      // fecha ao clicar fora do card
      accountPanel.addEventListener("click", (e) => {
        if (e.target === accountPanel) {
          fecharPainelConta();
        }
      });

      // -------- Tabs da barra inferior --------

      const tabs = document.querySelectorAll(".bottom-nav .tab");

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");

          const name = tab.dataset.tab;

          if (name === "conta") {
            abrirPainelConta();
          } else {
            fecharPainelConta();

            if (name !== "explorar") {
              alert(
                'Aba "' +
                  name +
                  '" ainda n√£o implementada. Aqui depois entra a tela de ' +
                  name +
                  "."
              );
            }
          }
        });
      });

      // ---- Edi√ß√£o de nome ----
      editNameBtn.addEventListener("click", () => {
        const currentName = accountNameEl.textContent.trim();
        nameEditInput.value =
          currentName === "Carregando..." || currentName === ""
            ? ""
            : currentName;
        nameEditContainer.classList.remove("hidden");
        nameEditInput.focus();
        nameEditInput.select();
      });

      nameCancelBtn.addEventListener("click", () => {
        nameEditContainer.classList.add("hidden");
      });

      nameSaveBtn.addEventListener("click", async () => {
        const novoNome = nameEditInput.value.trim();
        if (!novoNome) {
          alert("O nome n√£o pode ser vazio.");
          return;
        }

        try {
          const resp = await fetch("/api/me/name", {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ nome: novoNome }),
          });

          if (!resp.ok) {
            console.error("Erro ao atualizar nome:", resp.status);
            alert("N√£o foi poss√≠vel atualizar seu nome. Tente novamente.");
            return;
          }

          const data = await resp.json();
          accountNameEl.textContent = data.nome ?? novoNome;
          nameEditContainer.classList.add("hidden");
        } catch (e) {
          console.error("Erro na requisi√ß√£o de update de nome:", e);
          alert("Ocorreu um erro ao atualizar seu nome.");
        }
      });

      // -------- Mapa + OSM / Overpass --------

      // --------- Elementos da UI ---------
      const coordsDiv = document.getElementById("coords");
      const categoryFilterDiv = document.getElementById("category-filter");

      // --------- Estado da Aplica√ß√£o ---------
      let userActualLocation = null;
      let currentSearchCoords = null;
      let allFoundPlaces = [];
      const defaultLat = -22.9068;
      const defaultLon = -43.1729;
      const defaultRadius = 1500;
      const defaultCheckedCategories = new Set([
        'place_of_worship', 'restaurant', 'fast_food', 'cafe', 'bar',
        'ice_cream', 'pub', 'cinema', 'theatre', 'nightclub', 'university'
      ]);

      // Estilo para o c√≠rculo de raio
      const radiusCircleOptions = {
        color: '#000000',
        weight: 2,
        opacity: 1,
        fill: false,
        dashArray: '5, 10'
      };

      // --------- Inicializa√ß√£o do Mapa (Leaflet) ---------
      const map = L.map("map", { zoomControl: false }).setView([defaultLat, defaultLon], 12);
      L.control.zoom({ position: "topright" }).addTo(map);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution: "&copy; OpenStreetMap contributors" }).addTo(map);
      const markersLayer = L.layerGroup().addTo(map);
      const coordsDiv = document.getElementById("coords");

      function atualizarCoordsLabel(lat, lon, origem) {
        coordsDiv.textContent = `Localiza√ß√£o (${origem}): ${lat.toFixed(
          5
        )}, ${lon.toFixed(5)}`;
      }

      const userIcon = L.icon({
        iconUrl:
          "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
        shadowUrl:
          "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41],
      });

      const blueCircleIcon = L.divIcon({
        className: "blue-circle-icon",
        html: "<div></div>",
        iconSize: [16, 16],
        iconAnchor: [8, 8],
      });

      // üìå Pino vermelho (marcador de busca), m√≥vel
      let searchMarker = null;
      let locationMarker = null;
      let searchRadiusCircle = null; // C√≠rculo pontilhado do raio

      // --------- Controle Customizado "Home" ---------
      const HomeButton = L.Control.extend({
        options: { position: 'topright' },
        onAdd: function (map) {
          const btn = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
          btn.innerHTML = 'üè†';
          L.DomEvent.on(btn, 'click', (e) => {
            L.DomEvent.stop(e);
            if (userActualLocation) {
              map.setView([userActualLocation.lat, userActualLocation.lng], 14);
              setSearchMarker(userActualLocation.lat, userActualLocation.lng, "Buscando a partir da sua localiza√ß√£o");
            } else {
              alert(
                "Ainda n√£o foi poss√≠vel obter sua localiza√ß√£o inicial. Tente recarregar a p√°gina."
              );
            }
          });
          return btn;
        },
      });
      map.addControl(new HomeButton());

      // --------- L√≥gica de Eventos do Mapa ---------
      map.on("click", function (e) {
        const { lat, lng } = e.latlng;
        setSearchMarker(lat, lng, "Buscando a partir daqui");
      });

      categoryFilterDiv.addEventListener('change', () => {
        aplicarFiltroEAtualizarMapa();
      });

      // --------- Fun√ß√µes Principais da L√≥gica de Filtragem ---------
      function setSearchMarker(lat, lon, label) {
        currentSearchCoords = { lat, lon };
        atualizarCoordsLabel(`Buscando em: ${lat.toFixed(5)}, ${lon.toFixed(5)}`);
        
        if (searchMarker) {
          searchMarker.setLatLng([lat, lon]);
          searchMarker.setPopupContent(label);
        } else {
          searchMarker = L.marker([lat, lon], { icon: userIcon }).addTo(map).bindPopup(label).openPopup();
        }

        // Desenha ou move o c√≠rculo de raio
        if (searchRadiusCircle) {
          searchRadiusCircle.setLatLng([lat, lon]);
        } else {
          searchRadiusCircle = L.circle([lat, lon], { ...radiusCircleOptions, radius: defaultRadius }).addTo(map);
        }

        carregarPlaces();
      }

      async function carregarPlaces() {
        if (!currentSearchCoords) return;
        categoryFilterDiv.innerHTML = '<span class="loader">Buscando locais...</span>';
          markersLayer.clearLayers();
        const { lat, lon } = currentSearchCoords;
        try {
          const url = `/api/places?lat=${lat}&lon=${lon}&radius=${defaultRadius}`;
          const response = await fetch(url);
          if (!response.ok) {
            categoryFilterDiv.innerHTML = '<span class="loader">Erro na busca.</span>';
            if (response.status === 401 || response.status === 403) {
              alert("Sess√£o expirada. Por favor, fa√ßa login novamente.");
              window.location.href = "/";
            }
            return;
          }
          allFoundPlaces = await response.json();
          atualizarFiltroCategorias(allFoundPlaces);
          aplicarFiltroEAtualizarMapa();
        } catch (error) {
          console.error("Erro ao carregar places:", error);
          categoryFilterDiv.innerHTML = '<span class="loader">Erro na busca.</span>';
        }
      }

      function atualizarFiltroCategorias(places) {
        if (places.length === 0) {
          categoryFilterDiv.innerHTML = '<span class="loader">Nenhum local encontrado.</span>';
          return;
        }
        const categories = [...new Set(places.map(p => p.type))].sort();
        categoryFilterDiv.innerHTML = '<h4>Categorias</h4>';
        categories.forEach(cat => {
          const id = `cat-${cat}`;
          const item = document.createElement('div');
          item.className = 'category-item';
          const labelTraduzida = traducoes[cat] || cat.replace(/_/g, ' ');
          const isChecked = defaultCheckedCategories.has(cat) ? 'checked' : '';
          item.innerHTML = `
            <input type="checkbox" id="${id}" value="${cat}" ${isChecked}>
            <label for="${id}">${labelTraduzida}</label>
          `;
          categoryFilterDiv.appendChild(item);
        });
      }

      function aplicarFiltroEAtualizarMapa() {
        const selectedCategories = new Set(
          Array.from(categoryFilterDiv.querySelectorAll('input:checked')).map(input => input.value)
        );
        const placesFiltrados = allFoundPlaces.filter(place => selectedCategories.has(place.type));
        markersLayer.clearLayers();
        placesFiltrados.forEach((place) => {
          const marker = L.marker([place.lat, place.lon]).addTo(markersLayer);
          const tipoTraduzido = traducoes[place.type] || place.type.replace(/_/g, ' ');
          marker.bindPopup(`<b>${place.name}</b><br/>Tipo: ${tipoTraduzido}<br/><button onclick="combinarRole(${place.id})">Combinar rol√™</button>`);
        });
      }

      // --------- Fun√ß√µes Auxiliares ---------
      function atualizarCoordsLabel(texto) { coordsDiv.textContent = texto; }
      function combinarRole(placeId) { alert("Combinar rol√™ no lugar ID " + placeId + " (futuro: abrir fluxo de grupo/vota√ß√£o)"); }

      function carregarPosicaoPadrao(motivo) {
        console.warn(motivo);
        map.setView([defaultLat, defaultLon], 12);
        setSearchMarker(defaultLat, defaultLon, "Local padr√£o: Centro do Rio");
      }

      // --------- Fun√ß√£o Principal de Inicializa√ß√£o ---------
      async function inicializarMapa() {
        categoryFilterDiv.innerHTML = '<span class="loader">Mova o pino para buscar...</span>';
        if (!navigator.geolocation) {
          carregarPosicaoPadrao("Geolocaliza√ß√£o n√£o suportada no navegador.");
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const userLat = pos.coords.latitude;
            const userLon = pos.coords.longitude;
            userActualLocation = { lat: userLat, lng: userLon };
            map.setView([userLat, userLon], 14);
            if (locationMarker) locationMarker.remove();
            locationMarker = L.marker([userLat, userLon], { icon: blueCircleIcon, zIndexOffset: -100 }).addTo(map);
            setSearchMarker(userLat, userLon, "Buscando a partir da sua localiza√ß√£o");
          },
          (err) => {
            atualizarCoordsLabel("N√£o foi poss√≠vel obter sua localiza√ß√£o.");
            carregarPosicaoPadrao(`Erro ao obter localiza√ß√£o: ${err.message}`);
          },
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
        );
      }

      inicializarMapa();

      // --------- Overlay de CHAT (lista de amigos + conversa) ---------
      const chatOverlay = document.getElementById("chat-overlay");
      const chatAppContainer = document.getElementById("chat-app-container");
      const chatCloseBtn = document.getElementById("chat-close-btn");
      const contactSearchInput = document.getElementById("contact-search");
      const contactListEl = document.getElementById("contact-list");
      const chatHeaderTitleEl = document.getElementById("chat-header-title");
      const chatHeaderSubtitleEl = document.getElementById(
        "chat-header-subtitle"
      );
      const messagesContainerEl = document.getElementById("messages-container");
      const chatInputEl = document.getElementById("chat-input");
      const chatSendButtonEl = document.getElementById("chat-send-button");

      // mock inicial de amigos (depois pode vir do backend)
      const contacts = [
        { id: "joao", nome: "Jo√£o Silva" },
        { id: "maria", nome: "Maria Oliveira" },
        { id: "admin", nome: "Administrador" },
      ];

      // estado de mensagens por contato (mock, s√≥ em mem√≥ria)
      const chatState = {
        joao: [
          { from: "other", text: "Ol√°! Tudo bem?" },
          { from: "me", text: "Tudo √≥timo! E com voc√™?" },
          { from: "other", text: "Vamos marcar um rol√™ hoje?" },
        ],
        maria: [
          { from: "other", text: "Oi! Vi um bar novo em Copa." },
          { from: "me", text: "S√©rio? Bora testar no fim de semana!" },
        ],
        admin: [
          { from: "other", text: "Bem-vindo ao JaVai üëã" },
          {
            from: "other",
            text: "Use este chat para combinar rol√™s com seus amigos.",
          },
        ],
      };

      let currentContactId = null;

      function abrirChat() {
        chatOverlay.style.display = "flex";
        // se ainda n√£o tiver contato selecionado, escolhe o primeiro
        if (!currentContactId && contacts.length > 0) {
          selecionarContato(contacts[0].id);
        }
        chatInputEl.focus();
      }

      function fecharChat() {
        chatOverlay.style.display = "none";
      }

      // fechar ao clicar no X
      chatCloseBtn.addEventListener("click", () => {
        fecharChat();
      });

      // fechar clicando fora do card
      chatOverlay.addEventListener("click", (e) => {
        if (e.target === chatOverlay) {
          fecharChat();
        }
      });

      function renderContactList(filterText = "") {
        contactListEl.innerHTML = "";
        const term = filterText.trim().toLowerCase();

        contacts
          .filter((c) => !term || c.nome.toLowerCase().includes(term))
          .forEach((contact) => {
            const li = document.createElement("li");
            li.className = "contact-item";
            li.dataset.contactId = contact.id;

            if (contact.id === currentContactId) {
              li.classList.add("active");
            }

            const avatar = document.createElement("div");
            avatar.className = "contact-avatar";
            avatar.textContent = contact.nome.charAt(0).toUpperCase();

            const spanName = document.createElement("span");
            spanName.textContent = contact.nome;

            li.appendChild(avatar);
            li.appendChild(spanName);

            li.addEventListener("click", () => {
              selecionarContato(contact.id);
            });

            contactListEl.appendChild(li);
          });
      }

      function renderMessages() {
        messagesContainerEl.innerHTML = "";

        if (!currentContactId) {
          chatHeaderTitleEl.textContent = "Selecione um amigo";
          chatHeaderSubtitleEl.textContent = "A conversa aparece aqui";
          return;
        }

        const contact = contacts.find((c) => c.id === currentContactId);
        const msgs = chatState[currentContactId] || [];

        chatHeaderTitleEl.textContent = contact ? contact.nome : "Chat";
        chatHeaderSubtitleEl.textContent = "Converse sobre o pr√≥ximo rol√™";

        msgs.forEach((msg) => {
          const row = document.createElement("div");
          row.className = "message-row " + (msg.from === "me" ? "me" : "other");

          const bubble = document.createElement("div");
          bubble.className = "message-bubble";
          bubble.textContent = msg.text;

          // meta simples
          const meta = document.createElement("span");
          meta.className = "message-meta";
          meta.textContent = msg.from === "me" ? "Voc√™ ‚Ä¢ agora" : "";

          bubble.appendChild(meta);
          row.appendChild(bubble);
          messagesContainerEl.appendChild(row);
        });

        messagesContainerEl.scrollTop = messagesContainerEl.scrollHeight;
      }

      function selecionarContato(contactId) {
        currentContactId = contactId;
        if (!chatState[currentContactId]) {
          chatState[currentContactId] = [];
        }
        renderContactList(contactSearchInput.value);
        renderMessages();
      }

      function enviarMensagemAtual() {
        const text = chatInputEl.value.trim();
        if (!text || !currentContactId) return;

        chatState[currentContactId].push({
          from: "me",
          text,
        });

        chatInputEl.value = "";
        renderMessages();
      }

      chatSendButtonEl.addEventListener("click", enviarMensagemAtual);

      chatInputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          enviarMensagemAtual();
        }
      });

      contactSearchInput.addEventListener("input", (e) => {
        renderContactList(e.target.value);
      });

      // inicializa lista (sem abrir overlay ainda)
      renderContactList();

      // --------- Tabs (3: conta, explorar, chat) ---------
      const tabs = document.querySelectorAll(".bottom-nav .tab");
      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          const name = tab.dataset.tab;

          if (name === "explorar") {
            fecharChat();
            // se existir painel de conta, fechamos tamb√©m
            if (typeof fecharPainelConta === "function") {
              fecharPainelConta();
            }
          } else if (name === "conta") {
            fecharChat();
            // s√≥ chama se a fun√ß√£o existir (manter conta "como est√°")
            if (typeof abrirPainelConta === "function") {
              abrirPainelConta();
            } else {
              alert(
                'Aba "Conta" ainda n√£o implementada neste HTML (voc√™ pode ligar aqui com o painel de conta que j√° criamos).'
              );
            }
          } else if (name === "chat") {
            // fecha painel de conta se existir
            if (typeof fecharPainelConta === "function") {
              fecharPainelConta();
            }
            abrirChat();
          }
        });
      });
    </script>
  </body>
</html>
