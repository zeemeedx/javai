<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Mapa do Rio de Janeiro</title>

    <!-- CSS do Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      :root {
        --panel-bg: rgba(15, 23, 42, 0.85);
        --main-text: #e5e7eb;
        --border-color: #111827;
        --blue: #3b82f6;
        --dark-blue: #1d4ed8;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #020617;
        color: var(--main-text);
      }

      .app-header {
        padding: 8px 12px;
        background: #020617;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1001; /* Acima dos paineis */
      }

      .app-header .title {
        font-weight: 600;
      }
      .app-header .user {
        font-size: 0.8rem;
        color: #9ca3af;
      }

      #map {
        flex: 1;
        width: 100vw;
      }

      /* Painel de Coordenadas (movido para baixo) */
      #coords {
        position: absolute;
        bottom: 64px; /* Acima da barra de navega√ß√£o */
        left: 8px;
        background: var(--panel-bg);
        padding: 6px 8px;
        border-radius: 8px;
        font-size: 0.75rem;
        z-index: 1000;
        max-width: 300px;
      }

      /* Painel de Controles (Raio e Categorias) */
      #controls-panel {
        position: absolute;
        top: 44px;
        left: 8px;
        background: var(--panel-bg);
        padding: 8px 12px;
        border-radius: 8px;
        z-index: 1000;
        max-width: 200px;
      }

      #radius-control {
        font-size: 0.8rem;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #334155;
      }

      #radius-control label {
        display: block;
        margin-bottom: 4px;
      }

      #radius-control input[type="range"] {
        width: 100%;
        cursor: pointer;
      }

      /* Painel de Filtro de Categorias */
      #category-filter {
        /* position, background, padding, border-radius movidos para #controls-panel */
        font-size: 0.8rem;
        max-height: 40vh; /* ajustado */
        overflow-y: auto;
      }
      /* Esconder a barra de rolagem no Chrome/Safari, mas manter funcionalidade */
      #category-filter::-webkit-scrollbar {
        width: 0px;
        background: transparent;
      }
      #category-filter h4 {
        margin: 0 0 8px 0;
        font-size: 0.85rem;
        border-bottom: 1px solid #334155;
        padding-bottom: 4px;
      }
      .category-item {
        display: block;
        margin-bottom: 5px;
      }
      .category-item label {
        cursor: pointer;
        user-select: none;
        margin-left: 4px;
      }
      .category-item input {
        cursor: pointer;
      }

      /* Loader para categorias */
      .loader {
        font-size: 0.75rem;
        color: #9ca3af;
      }

      .bottom-nav {
        height: 56px;
        background: #020617;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-around;
        align-items: center;
      }

      .bottom-nav button {
        flex: 1;
        height: 100%;
        border: none;
        background: transparent;
        color: #9ca3af;
        font-size: 0.75rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
        cursor: pointer;
      }

      .bottom-nav button span.icon {
        font-size: 1.2rem;
      }

      .bottom-nav button.active {
        color: #3b82f6;
        border-top: 2px solid #3b82f6;
      }

      @media (max-width: 480px) {
        .app-header {
          font-size: 0.8rem;
        }
        #coords {
          font-size: 0.7rem;
          bottom: 60px;
        }
        #category-filter {
          font-size: 0.75rem;
          padding: 6px 8px;
        }
      }

      /* -------- Overlay + Card da Conta -------- */

      .account-overlay {
        position: fixed;
        inset: 0;
        /* fundo escuro por√©m transl√∫cido, deixando o mapa aparecer atr√°s */
        background: rgba(3, 7, 18, 0.45);
        backdrop-filter: blur(3px);
        display: none; /* controlado via JS */
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 16px;
      }

      .account-card {
        width: 100%;
        max-width: 420px;
        background: radial-gradient(
            circle at top right,
            rgba(59, 130, 246, 0.16),
            transparent 55%
          ),
          radial-gradient(
            circle at bottom left,
            rgba(56, 189, 248, 0.12),
            transparent 60%
          ),
          #020617;
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        box-shadow: 0 28px 60px rgba(15, 23, 42, 0.9),
          0 0 0 1px rgba(15, 23, 42, 0.8);
        padding: 18px 18px 14px;
        color: #e5e7eb;
        position: relative;
        overflow: hidden;
      }

      .account-card::before {
        content: "";
        position: absolute;
        inset: -40%;
        background: radial-gradient(
          circle at 0 0,
          rgba(96, 165, 250, 0.18),
          transparent 55%
        );
        opacity: 0.7;
        pointer-events: none;
        mix-blend-mode: screen;
      }

      .account-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        position: relative;
        z-index: 1;
      }

      .account-card-header h3 {
        margin: 0;
        font-size: 1.1rem;
        letter-spacing: 0.02em;
      }

      .account-card-header span.sub {
        display: block;
        font-size: 0.76rem;
        color: #9ca3af;
        margin-top: 2px;
      }

      .account-panel-close {
        border: none;
        background: rgba(15, 23, 42, 0.8);
        color: #9ca3af;
        cursor: pointer;
        font-size: 1.1rem;
        width: 28px;
        height: 28px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .account-panel-close:hover {
        background: rgba(248, 113, 113, 0.12);
        color: #fecaca;
      }

      .account-profile {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
        position: relative;
        z-index: 1;
      }
      .name-row {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .name-row .name {
        font-size: 1rem;
        font-weight: 600;
      }

      .edit-icon {
        border: none;
        background: transparent;
        color: #9ca3af;
      }
      /* Bot√£o customizado para o Leaflet */
      .leaflet-control-custom {
        background-color: white;
        border: 2px solid rgba(0, 0, 0, 0.2);
        background-clip: padding-box;
        border-radius: 4px;
        width: 34px !important;
        height: 34px !important;
        text-align: center;
        line-height: 30px;
        font-size: 1.2rem;
        cursor: pointer;
        font-size: 0.85rem;
        padding: 2px;
        border-radius: 999px;
      }

      .edit-icon:hover {
        background: rgba(148, 163, 184, 0.15);
        color: #e5e7eb;
      }

      .name-edit {
        margin-top: 6px;
        display: flex;
        gap: 6px;
      }

      .name-edit input {
        flex: 1;
        padding: 4px 6px;
        border-radius: 8px;
        border: 1px solid #4b5563;
        background: #020617;
        color: #e5e7eb;
        font-size: 0.85rem;
      }

      .name-edit input:focus {
        outline: none;
        border-color: #3b82f6;
      }

      .name-edit button {
        padding: 4px 8px;
        border-radius: 999px;
        border: none;
        font-size: 0.78rem;
        cursor: pointer;
      }

      #name-save-btn {
        background: #3b82f6;
        color: #e5e7eb;
      }

      #name-save-btn:hover {
        background: #2563eb;
      }

      #name-cancel-btn {
        background: #111827;
        color: #e5e7eb;
      }

      #name-cancel-btn:hover {
        background: #1f2937;
      }

      /* utilit√°ria pra esconder blocos */
      .hidden {
        display: none;
      }

      .avatar-circle {
        width: 52px;
        height: 52px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        /* gradiente padr√£o quando n√£o tem foto */
        background: radial-gradient(circle at 30% 20%, #38bdf8, #1d4ed8);
        color: #e5e7eb;
        font-weight: 700;
        font-size: 1.4rem;
        box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.9);
        cursor: pointer; /* üëà indica que √© clic√°vel */
        overflow: hidden; /* corta bordas da imagem */
        background-size: cover; /* imagem cobre o c√≠rculo */
        background-position: center; /* centraliza a imagem */
      }

      .profile-main {
        flex: 1;
      }

      .profile-main .name {
        font-size: 1rem;
        font-weight: 600;
      }

      .profile-main .email {
        font-size: 0.8rem;
        color: #cbd5f5;
        word-break: break-all;
      }

      .profile-tags {
        margin-top: 6px;
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .chip {
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 0.7rem;
        border: 1px solid rgba(148, 163, 184, 0.4);
        color: #9ca3af;
        background: rgba(15, 23, 42, 0.85);
      }

      .chip-action {
        cursor: pointer;
        padding: 6px 16px;
        font-size: 0.8rem;
        border: 1px solid rgba(248, 113, 113, 0.4);
        color: #fecaca;
        background: rgba(127, 29, 29, 0.25);
        transition: background 0.2s ease;
      }

      .chip-action:hover {
        background: rgba(153, 27, 27, 0.4);
      }

      .account-sections {
        margin-top: 6px;
        position: relative;
        z-index: 1;
      }

      .account-section {
        margin-bottom: 10px;
        padding: 8px 10px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.92);
        border: 1px solid rgba(31, 41, 55, 0.9);
      }

      .account-section.account-logout {
        display: flex;
        justify-content: center;
        margin-top: 16px;
      }

      .account-section h4 {
        margin: 0 0 6px;
        font-size: 0.86rem;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        color: #9ca3af;
      }

      .list-compact {
        list-style: none;
        margin: 0;
        padding: 0;
        font-size: 0.8rem;
      }

      .list-compact li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        border-bottom: 1px solid rgba(31, 41, 55, 0.7);
      }

      .list-compact li:last-child {
        border-bottom: none;
      }

      .list-compact span.label {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .pill {
        font-size: 0.68rem;
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(37, 99, 235, 0.18);
        color: #bfdbfe;
      }

      .pill-secondary {
        background: rgba(55, 65, 81, 0.8);
        color: #e5e7eb;
      }

      @media (max-width: 480px) {
        .account-card {
          padding: 16px 14px 12px;
        }
      }

      /* --- Amigos na aba Conta --- */

      #account-friends {
        margin-top: 16px;
        border-top: 1px solid rgba(148, 163, 184, 0.25);
        padding-top: 12px;
      }

      #account-friends h4 {
        margin: 0;
        font-size: 0.9rem;
      }

      .friends-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .friends-header button {
        padding: 4px 10px;
        font-size: 0.75rem;
        border-radius: 999px;
        border: 1px solid #3b82f6;
        background: rgba(59, 130, 246, 0.12);
        color: #e5e7eb;
        cursor: pointer;
      }

      .friends-header button:hover {
        background: rgba(59, 130, 246, 0.22);
      }

      /* painel de busca de amigos */
      .friends-search {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(31, 41, 55, 0.7);
      }

      .friends-search.hidden {
        display: none;
      }

      .friends-search-bar {
        display: flex;
        gap: 6px;
        margin-bottom: 8px;
      }

      .friends-search-bar input {
        flex: 1;
        padding: 6px 8px;
        border-radius: 999px;
        border: 1px solid #4b5563;
        background: #020617;
        color: #e5e7eb;
        font-size: 0.8rem;
      }

      .friends-search-bar input::placeholder {
        color: #6b7280;
      }

      .friends-search-bar button {
        padding: 0 12px;
        border-radius: 999px;
        border: none;
        background: #3b82f6;
        color: #e5e7eb;
        font-size: 0.8rem;
        cursor: pointer;
      }

      /* linhas de amigo / resultado de busca */
      .friend-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 0;
        border-bottom: 1px solid rgba(31, 41, 55, 0.7);
        font-size: 0.8rem;
      }

      .friend-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .friend-avatar {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        background: linear-gradient(135deg, #3b82f6, #06b6d4);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: #e5e7eb;
      }

      .friend-name {
        font-weight: 600;
      }

      .friend-email {
        color: #9ca3af;
        font-size: 0.72rem;
      }

      .friend-right button {
        font-size: 0.75rem;
        border-radius: 999px;
        padding: 3px 10px;
        border: none;
        cursor: pointer;
      }

      /* estilos dos bot√µes de status */
      .friend-btn-primary {
        background: #3b82f6;
        color: #e5e7eb;
      }

      .friend-btn-disabled {
        background: #1f2937;
        color: #9ca3af;
        cursor: default;
      }

      .friend-btn-danger {
        background: rgba(220, 38, 38, 0.2);
        color: #fca5a5;
        border: 1px solid rgba(220, 38, 38, 0.5);
      }
      .friend-btn-danger:hover {
        background: rgba(220, 38, 38, 0.4);
        color: #fecaca;
      }

      .toast-container {
        position: fixed;
        right: 18px;
        bottom: 90px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 2500;
        pointer-events: none;
      }

      .toast-card {
        min-width: 260px;
        max-width: 320px;
        background: rgba(2, 6, 23, 0.92);
        border: 1px solid rgba(96, 165, 250, 0.4);
        border-radius: 12px;
        padding: 12px 14px;
        color: #e5e7eb;
        box-shadow: 0 16px 40px rgba(2, 6, 23, 0.8);
        pointer-events: auto;
      }

      .toast-card p {
        margin: 0 0 10px;
        font-size: 0.85rem;
        line-height: 1.2rem;
      }

      .toast-actions {
        display: flex;
        gap: 8px;
      }

      .toast-actions button {
        flex: 1;
        padding: 6px 0;
        border-radius: 999px;
        border: none;
        font-size: 0.78rem;
        cursor: pointer;
      }

      .toast-actions button.accept {
        background: #16a34a;
        color: #ecfccb;
      }

      .toast-actions button.reject {
        background: rgba(15, 23, 42, 0.8);
        color: #fecaca;
        border: 1px solid rgba(248, 113, 113, 0.4);
      }

      .feedback-toast {
        position: fixed;
        left: 50%;
        bottom: 72px;
        transform: translate(-50%, 20px);
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.35);
        border-radius: 999px;
        padding: 10px 18px;
        color: #e5e7eb;
        font-size: 0.85rem;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 2700;
      }

      .feedback-toast.visible {
        opacity: 1;
        transform: translate(-50%, 0);
      }

      /* √çcone de c√≠rculo azul para a localiza√ß√£o real do usu√°rio */
      .blue-circle-icon div {
        width: 16px;
        height: 16px;
        background-color: var(--blue);
        border: 2px solid var(--dark-blue);
        border-radius: 50%;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.5);
      }

      /* -------- Overlay do Chat (mapa ao fundo, estilo Telegram) -------- */

      .overlay-chat {
        position: fixed;
        inset: 0;
        background: rgba(3, 7, 18, 0.45); /* mapa aparece atr√°s */
        backdrop-filter: blur(4px);
        display: none; /* controlado via JS */
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 16px;
      }

      /* container principal do chat */
      .chat-app-container {
        width: min(100%, 960px);
        height: min(80vh, 620px);
        background: #020617;
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 24px 60px rgba(15, 23, 42, 0.85),
          0 0 0 1px rgba(15, 23, 42, 0.9);
        display: flex;
        border: 1px solid rgba(148, 163, 184, 0.35);
      }

      /* SIDEBAR (lista de amigos) */

      .sidebar {
        width: 30%;
        min-width: 230px;
        background: #020617;
        border-right: 1px solid #111827;
        display: flex;
        flex-direction: column;
      }

      .sidebar-header {
        padding: 10px 12px;
        border-bottom: 1px solid #111827;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .sidebar-header-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .sidebar-header h3 {
        margin: 0;
        font-size: 0.9rem;
        color: #e5e7eb;
      }

      .sidebar-header button {
        border: 1px solid rgba(59, 130, 246, 0.4);
        background: rgba(59, 130, 246, 0.18);
        color: #cfe3ff;
        border-radius: 999px;
        padding: 4px 12px;
        font-size: 0.75rem;
        cursor: pointer;
      }

      .sidebar-header button:hover {
        background: rgba(59, 130, 246, 0.3);
      }

      .sidebar-header input {
        width: 100%;
        padding: 6px 8px;
        border-radius: 999px;
        border: 1px solid #4b5563;
        background: #020617;
        color: #e5e7eb;
        font-size: 0.8rem;
      }

      .sidebar-header input::placeholder {
        color: #6b7280;
      }

      .sidebar-header input:focus {
        outline: none;
        border-color: #3b82f6;
      }

      .contact-list {
        list-style: none;
        padding: 4px 0;
        margin: 0;
        overflow-y: auto;
        flex: 1;
      }

      .contact-item {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        cursor: pointer;
        gap: 10px;
        font-size: 0.85rem;
        color: #e5e7eb;
        transition: background 0.2s ease;
      }

      .contact-item:hover {
        background: rgba(15, 23, 42, 0.85);
      }

      .contact-item.active {
        background: rgba(37, 99, 235, 0.18);
      }

      .contact-info {
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Para o ellipsis funcionar */
      }
      
      .contact-name {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .contact-subtitle {
        font-size: 0.75rem;
        color: #94a3b8;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .contact-avatar {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        background: linear-gradient(135deg, #3b82f6, #06b6d4);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        color: #e5e7eb;
      }

      /* √ÅREA PRINCIPAL DO CHAT */

      .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #020617;
      }

.chat-header {
        padding: 10px 12px;
        border-bottom: 1px solid #111827;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .chat-voting-panel {
        padding: 10px 12px;
        border-bottom: 1px solid #111827;
        background: rgba(15, 23, 42, 0.75);
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .chat-voting-panel.hidden {
        display: none;
      }

      .voting-status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 0.72rem;
        border: 1px solid rgba(59, 130, 246, 0.4);
        color: #93c5fd;
        background: rgba(59, 130, 246, 0.12);
        width: fit-content;
      }

      .voting-panel-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .voting-panel-actions button {
        border-radius: 999px;
        border: 1px solid rgba(59, 130, 246, 0.4);
        background: rgba(59, 130, 246, 0.18);
        color: #e0f2fe;
        padding: 5px 14px;
        font-size: 0.78rem;
        cursor: pointer;
      }

      .voting-panel-actions button.secondary {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.3);
        color: #cbd5f5;
      }

      .voting-panel-actions button:hover {
        background: rgba(59, 130, 246, 0.3);
      }

      .voting-options-list {
        list-style: none;
        padding: 0;
        margin: 4px 0 0 0;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .voting-options-list li {
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.2);
        font-size: 0.72rem;
        color: #e5e7eb;
      }

      .chat-header-left {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .chat-title {
        font-size: 0.9rem;
        font-weight: 600;
      }

      .chat-subtitle {
        font-size: 0.7rem;
        color: #9ca3af;
      }

      .chat-close-btn {
        border: none;
        background: rgba(15, 23, 42, 0.9);
        color: #9ca3af;
        cursor: pointer;
        font-size: 1rem;
        width: 26px;
        height: 26px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chat-close-btn:hover {
        background: rgba(148, 163, 184, 0.25);
        color: #e5e7eb;
      }

      /* Mensagens */

      .messages-container {
        flex: 1;
        padding: 12px 12px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 0.8rem;
      }

      .message-row {
        display: flex;
      }

      .message-row.me {
        justify-content: flex-end;
      }

      .message-row.other {
        justify-content: flex-start;
      }

      .message-bubble {
        max-width: 68%;
        padding: 7px 10px;
        border-radius: 14px;
        line-height: 1.4;
        word-wrap: break-word;
      }

      .message-row.me .message-bubble {
        background: #3b82f6;
        color: #e5e7eb;
        border-bottom-right-radius: 4px;
      }

      .message-row.other .message-bubble {
        background: #111827;
        color: #e5e7eb;
        border-bottom-left-radius: 4px;
        border: 1px solid #1f2937;
      }

      .message-meta {
        display: block;
        font-size: 0.65rem;
        color: #9ca3af;
        margin-top: 2px;
      }

      /* Input */

      .input-area {
        padding: 14px 16px;
        border-top: 1px solid #111827;
        display: flex;
        gap: 10px;
        background: #020617;
        align-items: center;
      }

      .input-area input {
        flex: 1;
        padding: 10px 14px;
        border-radius: 18px;
        border: 1px solid #1f2937;
        background: #0f172a;
        color: #e5e7eb;
        font-size: 0.85rem;
      }

      .input-area input::placeholder {
        color: #6b7280;
      }

      .input-area input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3);
      }

      .input-area button {
        padding: 0 18px;
        border-radius: 18px;
        border: none;
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        color: #f8fafc;
        cursor: pointer;
        font-size: 0.85rem;
        height: 40px;
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .input-area button:hover {
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
      }

      .share-favorite-btn {
        width: 40px;
        height: 40px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(14, 116, 144, 0.25));
        border: 1px solid rgba(59, 130, 246, 0.4);
        border-radius: 50%;
        color: #e0f2fe;
        box-shadow: 0 10px 20px rgba(2, 6, 23, 0.65);
      }

      .share-favorite-btn:hover {
        background: linear-gradient(145deg, rgba(59, 130, 246, 0.3), rgba(14, 116, 144, 0.35));
      }

      .favorite-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(3, 7, 18, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2600;
      }

      .favorite-modal-overlay.visible {
        display: flex;
      }

      .favorite-modal {
        width: min(420px, 92vw);
        max-height: 72vh;
        background: radial-gradient(
              circle at top left,
              rgba(59, 130, 246, 0.15),
              transparent 55%
            ),
          #020617;
        border-radius: 22px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        box-shadow: 0 35px 80px rgba(2, 6, 23, 0.95);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .favorite-modal header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .favorite-modal header h3 {
        margin: 0;
        font-size: 1rem;
        letter-spacing: 0.03em;
      }

      .favorite-modal header button {
        border: none;
        background: rgba(15, 23, 42, 0.8);
        color: #e5e7eb;
        width: 32px;
        height: 32px;
        border-radius: 999px;
        cursor: pointer;
      }

      .favorite-modal header button:hover {
        background: rgba(59, 130, 246, 0.3);
      }

      .favorite-list {
        overflow-y: auto;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .favorite-item-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(59, 130, 246, 0.2);
        transition: background 0.2s ease;
      }

      .favorite-item-row:hover {
        background: rgba(15, 23, 42, 0.9);
      }

      .favorite-item-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .favorite-item-info strong {
        font-size: 0.92rem;
      }

      .favorite-item-info span {
        font-size: 0.78rem;
        color: #94a3b8;
      }

      .favorite-item-row button {
        border-radius: 999px;
        padding: 4px 14px;
        font-size: 0.78rem;
        border: none;
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        color: #f8fafc;
      }

      .favorite-item-row button:hover {
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
      }

      .group-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2600;
      }

      .group-modal-overlay.visible {
        display: flex;
      }

      .group-modal {
        width: min(480px, 92vw);
        max-height: 75vh;
        background: #020617;
        border-radius: 20px;
        border: 1px solid rgba(59, 130, 246, 0.25);
        box-shadow: 0 35px 80px rgba(2, 6, 23, 0.95);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .group-modal header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .group-modal header h3 {
        margin: 0;
        font-size: 1rem;
      }

      .group-modal header button {
        border: none;
        background: rgba(15, 23, 42, 0.8);
        color: #cbd5f5;
        width: 32px;
        height: 32px;
        border-radius: 999px;
        cursor: pointer;
      }

      .group-modal header button:hover {
        background: rgba(59, 130, 246, 0.35);
      }

      .group-modal input {
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid #1f2937;
        background: #0f172a;
        color: #e5e7eb;
        font-size: 0.85rem;
      }

      .group-modal input:focus {
        outline: none;
        border-color: #3b82f6;
      }

      .group-friends-list {
        flex: 1;
        overflow-y: auto;
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 12px;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .group-friend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        border-radius: 10px;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(59, 130, 246, 0.2);
      }

      .group-modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .group-modal-actions button {
        border-radius: 999px;
        padding: 8px 16px;
        border: none;
        font-size: 0.85rem;
        cursor: pointer;
      }

      .group-modal-actions button.primary {
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        color: #f8fafc;
      }

      .group-modal-actions button.secondary {
        background: rgba(15, 23, 42, 0.85);
        color: #cbd5f5;
        border: 1px solid rgba(148, 163, 184, 0.3);
      }

      .voting-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(3, 7, 18, 0.75);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2600;
      }

      .voting-modal-overlay.visible {
        display: flex;
      }

      .voting-modal {
        width: min(520px, 94vw);
        max-height: 78vh;
        background: #010511;
        border-radius: 22px;
        border: 1px solid rgba(59, 130, 246, 0.25);
        box-shadow: 0 35px 90px rgba(2, 6, 23, 0.95);
        padding: 22px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .voting-modal header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .voting-modal header h3 {
        margin: 0;
        font-size: 1.05rem;
      }

      .voting-modal header button {
        border: none;
        background: rgba(15, 23, 42, 0.8);
        width: 34px;
        height: 34px;
        border-radius: 999px;
        color: #cbd5f5;
        cursor: pointer;
      }

      .voting-modal header button:hover {
        background: rgba(59, 130, 246, 0.35);
      }

      .voting-modal-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow-y: auto;
      }

      .voting-selection-list {
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 14px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .voting-selection-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 10px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.2);
        gap: 6px;
      }

      .voting-selection-item strong {
        font-size: 0.9rem;
      }

      .voting-selection-controls {
        display: flex;
        gap: 6px;
      }

      .voting-selection-controls button {
        border: none;
        background: rgba(15, 23, 42, 0.85);
        color: #e5e7eb;
        border: 1px solid rgba(148, 163, 184, 0.3);
        width: 28px;
        height: 28px;
        border-radius: 999px;
        cursor: pointer;
      }

      .voting-selection-controls button:hover {
        border-color: rgba(59, 130, 246, 0.6);
      }

      .voting-modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .voting-modal-actions button {
        border-radius: 999px;
        border: none;
        padding: 8px 20px;
        font-size: 0.85rem;
        cursor: pointer;
      }

      .voting-modal-actions button.primary {
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        color: #f8fafc;
      }

      .voting-modal-actions button.secondary {
        background: rgba(15, 23, 42, 0.85);
        color: #cbd5f5;
        border: 1px solid rgba(148, 163, 184, 0.3);
      }

      .voting-selection-item button.remove-btn {
        background-color: #dc2626; /* Red color for remove */
        color: white;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .voting-selection-item button.remove-btn:hover {
        background-color: #b91c1c; /* Darker red on hover */
      }

      .favorite-share-card {
        margin-top: 8px;
        border: 1px solid rgba(59, 130, 246, 0.35);
        border-radius: 10px;
        padding: 8px;
        background: rgba(15, 23, 42, 0.7);
        font-size: 0.78rem;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .favorite-share-card strong {
        font-size: 0.85rem;
      }

      .favorite-share-card button {
        margin-top: 4px;
        align-self: flex-start;
        background: #1e3a8a;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.72rem;
      }

      .favorite-share-card button:hover {
        background: #1d4ed8;
      }

      .favorite-share-card-buttons {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }

      .favorite-share-card-button {
        flex: 1;
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 0.75rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        color: white;
        transition: background-color 0.2s ease;
      }

      .favorite-share-card-button.maps {
        background-color: #1e3a8a;
      }
      .favorite-share-card-button.maps:hover {
        background-color: #1d4ed8;
      }

      .favorite-share-card-button.favorite {
        background-color: #3b82f6; /* Default blue for Favoritar */
      }
      .favorite-share-card-button.favorite.favorited {
        background-color: #dc2626; /* Red for Desfavoritar */
      }
      .favorite-share-card-button.favorite:hover {
        background-color: #2563eb;
      }
      .favorite-share-card-button.favorite.favorited:hover {
        background-color: #b91c1c;
      }

      /* Responsivo */

      @media (max-width: 768px) {
        .chat-app-container {
          width: 100%;
          height: 80vh;
          border-radius: 16px;
        }

        .sidebar {
          width: 38%;
          min-width: 0;
        }

        .message-bubble {
          max-width: 80%;
        }
      }

      @media (max-width: 540px) {
        .chat-app-container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid #111827;
        }
      }

      /* --- Custom Popup --- */
      .custom-popup .leaflet-popup-content-wrapper {
        background: #0f172a; /* um azul bem escuro */
        color: #e2e8f0;
        border: 1px solid #334155;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      }

      .custom-popup .leaflet-popup-content {
        margin: 10px 14px;
        font-size: 0.85rem;
        line-height: 1.5;
        width: 200px !important; /* Definir uma largura fixa para o popup */
      }

      .custom-popup .leaflet-popup-tip {
        background: #0f172a;
      }

      .custom-popup .popup-header {
        font-size: 1rem;
        font-weight: 700;
        color: #f1f5f9;
        margin-bottom: 4px;
        max-width: 220px; /* Evita que nomes longos quebrem o layout */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .custom-popup .popup-type {
        font-style: italic;
        color: #94a3b8;
        margin-bottom: 10px;
      }

      .custom-popup .popup-btn {
        flex: 1;
        padding: 6px 8px;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }

      .custom-popup .popup-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px; /* Adicionado um margin-top para separar do tipo */
      }

      .popup-btn.maps {
        background-color: #1e3a8a; /* azul escuro */
        color: #e0f2fe;
      }
      .popup-btn.maps:hover {
        background-color: #1e40af;
      }

      .popup-btn.favorite {
        background-color: #374151; /* cinza */
        color: #d1d5db;
      }
      .popup-btn.favorite:hover {
        background-color: #4b5563;
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="title">JaVai</div>
      <div class="user">Online</div>
    </header>

    <div id="controls-panel">
      <div id="radius-control">
        <label for="radius-slider"
          >Raio: <span id="radius-value">1500m</span></label
        >
        <input
          type="range"
          id="radius-slider"
          min="500"
          max="5000"
          step="100"
          value="1500"
        />
      </div>
      <div id="category-filter"></div>
    </div>
    <div id="coords">Localiza√ß√£o: carregando...</div>

    <div id="map"></div>

    <!-- Overlay da Conta -->
    <div id="account-panel" class="account-overlay" style="display: none">
      <div class="account-card" id="account-card">
        <div class="account-card-header">
          <div>
            <h3>Sua conta</h3>
            <span class="sub">Configura√ß√µes e hist√≥rico do seu rol√™</span>
          </div>
          <button
            class="account-panel-close"
            id="close-account-panel"
            aria-label="Fechar"
          >
            ‚úï
          </button>
        </div>

        <div class="account-profile">
          <div
            class="avatar-circle"
            id="account-avatar"
            title="Clique para alterar sua foto"
          >
            ?
          </div>

          <input
            type="file"
            id="avatar-input"
            accept="image/*"
            style="display: none"
          />

          <div class="profile-main">
            <div class="name-row">
              <span class="name" id="account-name">Carregando...</span>
              <button
                type="button"
                class="edit-icon"
                id="edit-name-btn"
                title="Editar nome"
              >
                ‚úèÔ∏è
              </button>
            </div>

            <div class="name-edit hidden" id="name-edit-container">
              <input
                type="text"
                id="name-edit-input"
                maxlength="60"
                placeholder="Digite seu nome"
              />
              <button type="button" id="name-save-btn">Salvar</button>
              <button type="button" id="name-cancel-btn">Cancelar</button>
            </div>

            <div class="email" id="account-email">‚Äî</div>
            <div class="profile-tags">
              <span class="chip">Usu√°rio ativo</span>
              <span class="chip">Explorador de rol√™s</span>
            </div>
          </div>
        </div>

        <div class="account-sections">
          <!-- üîπ NOVA se√ß√£o de amigos -->
          <div class="account-section" id="account-friends">
            <div class="friends-header">
              <h4>Lista de amigos</h4>
              <button id="btn-open-add-friend" type="button">
                Adicionar amigos
              </button>
            </div>

            <!-- Lista de amigos atuais -->
            <div id="friends-list">
              <!-- preenchido via JS -->
            </div>

            <!-- Painel de busca de amigos (inicialmente escondido) -->
            <div id="add-friend-panel" class="friends-search hidden">
              <div class="friends-search-bar">
                <input
                  type="text"
                  id="friend-search-input"
                  placeholder="Buscar por nome ou e-mail..."
                />
                <button id="friend-search-btn" type="button">Buscar</button>
              </div>
              <div id="friend-search-results">
                <!-- resultados da busca via JS -->
              </div>
            </div>
          </div>
        </div>

        <div class="account-section account-logout">
          <button id="logout-button" type="button" class="chip chip-action">
            Sair da conta
          </button>
        </div>
      </div>
    </div>

    <!-- Overlay do CHAT -->
    <div id="chat-overlay" class="overlay-chat">
      <div class="chat-app-container" id="chat-app-container">
        <!-- SIDEBAR: lista de amigos -->
        <aside class="sidebar">
          <div class="sidebar-header">
            <div class="sidebar-header-top">
              <h3>Conversas</h3>
              <button type="button" id="btn-open-create-group">Criar grupo</button>
            </div>
            <input
              type="text"
              id="contact-search"
              placeholder="Buscar pelo nome..."
            />
          </div>
          <ul class="contact-list" id="contact-list">
            <!-- preenchida via JS -->
          </ul>
        </aside>

        <!-- √ÅREA DO CHAT -->
        <section class="chat-area">
          <header class="chat-header">
            <div class="chat-header-left">
              <div class="chat-title" id="chat-header-title">
                Selecione um amigo
              </div>
              <div class="chat-subtitle" id="chat-header-subtitle">
                A conversa aparece aqui
              </div>
            </div>
            <button
              class="chat-close-btn"
              id="chat-close-btn"
              aria-label="Fechar chat"
            >
              ‚úï
            </button>
          </header>

          <div id="chat-voting-panel" class="chat-voting-panel hidden"></div>

          <div class="messages-container" id="messages-container">
            <!-- mensagens do contato selecionado -->
          </div>

          <div class="input-area">
            <button
              type="button"
              id="chat-share-favorite"
              class="share-favorite-btn"
              title="Compartilhar favorito"
            >
              +
            </button>
            <input
              type="text"
              id="chat-input"
              placeholder="Digite uma mensagem..."
            />
            <button type="button" id="chat-send-button">Enviar</button>
          </div>
        </section>
      </div>
    </div>

    <nav class="bottom-nav">
      <button class="tab" data-tab="conta">
        <span class="icon">‚öôÔ∏è</span>
        <span>Conta</span>
      </button>
      <button class="tab active" data-tab="explorar">
        <span class="icon">üß≠</span>
        <span>Explorar</span>
      </button>
      <button class="tab" data-tab="chat">
        <span class="icon">üí¨</span>
        <span>Chat</span>
      </button>
    </nav>

    <div id="friend-request-toasts" class="toast-container"></div>
    <div id="feedback-toast" class="feedback-toast" role="status" aria-live="polite"></div>
    <div id="favorite-modal-overlay" class="favorite-modal-overlay">
      <div class="favorite-modal">
        <header>
          <h3>Meus favoritos</h3>
          <button type="button" id="favorite-modal-close">‚úï</button>
        </header>
        <p
          id="favorite-modal-hint"
          style="margin:0;font-size:0.82rem;color:#94a3b8;"
        >
          Envie rapidamente seus lugares salvos no chat.
        </p>
        <div id="favorite-modal-list" class="favorite-list"></div>
      </div>
    </div>

    <div id="voting-modal-overlay" class="voting-modal-overlay">
      <div class="voting-modal">
        <header>
          <h3 id="voting-modal-title">Vota√ß√£o</h3>
          <button type="button" id="voting-modal-close">‚úï</button>
        </header>
        <p
          id="voting-modal-hint"
          style="margin:0;font-size:0.82rem;color:#94a3b8;"
        >
        </p>
        <div id="voting-modal-body" class="voting-modal-body"></div>
        <div class="voting-modal-actions">
          <button type="button" class="secondary" id="voting-modal-cancel">
            Cancelar
          </button>
          <button type="button" class="primary" id="voting-modal-primary">
            Confirmar
          </button>
        </div>
      </div>
    </div>

    <div id="group-modal-overlay" class="group-modal-overlay">
      <div class="group-modal">
        <header>
          <h3>Novo grupo</h3>
          <button type="button" id="group-modal-close">‚úï</button>
        </header>
        <input
          type="text"
          id="group-name-input"
          placeholder="Nome do grupo"
          maxlength="60"
        />
        <p style="margin:0;font-size:0.8rem;color:#94a3b8;">
          Escolha os amigos para participar (voc√™ ser√° o admin).
        </p>
        <div id="group-friends-list" class="group-friends-list"></div>
        <div class="group-modal-actions">
          <button type="button" class="secondary" id="group-modal-cancel">
            Cancelar
          </button>
          <button type="button" class="primary" id="group-modal-create">
            Criar grupo
          </button>
        </div>
      </div>
    </div>

    <!-- JS do Leaflet -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="js/traducoes.js" defer></script>

    <script>
      // -------- Overlay da Conta / UI --------

      const accountPanel = document.getElementById("account-panel");
      const accountCard = document.getElementById("account-card");
      const closeAccountBtn = document.getElementById("close-account-panel");
      const accountNameEl = document.getElementById("account-name");
      const accountEmailEl = document.getElementById("account-email");
      const accountAvatarEl = document.getElementById("account-avatar");
      const avatarInputEl = document.getElementById("avatar-input");
      const rolesListEl = document.getElementById("roles-list");
      const editNameBtn = document.getElementById("edit-name-btn");
      const nameEditContainer = document.getElementById("name-edit-container");
      const nameEditInput = document.getElementById("name-edit-input");
      const nameSaveBtn = document.getElementById("name-save-btn");
      const nameCancelBtn = document.getElementById("name-cancel-btn");
      const logoutButton = document.getElementById("logout-button");
      const friendRequestToastsEl = document.getElementById(
        "friend-request-toasts"
      );
      const feedbackToastEl = document.getElementById("feedback-toast");
      const favoritePlacesCache = new Map();
      let favoritePlacesList = [];
      let feedbackToastTimeout = null;
      const displayedFriendRequestToastIds = new Set();

      let avatarCustomizado = false;

      const mockFriends = [
        { nome: "Ana", tag: "@ana_rol√™s" },
        { nome: "Bruno", tag: "@bruno.bike" },
        { nome: "Carla", tag: "@carla.sunset" },
      ];

      function initialsFromName(name) {
        if (!name) return "?";
        const parts = name.trim().split(/\s+/);
        if (parts.length === 1) {
          return parts[0].charAt(0).toUpperCase();
        }
        return (
          parts[0].charAt(0).toUpperCase() +
          parts[parts.length - 1].charAt(0).toUpperCase()
        );
      }
      // clique no avatar abre seletor de arquivo
      accountAvatarEl.addEventListener("click", () => {
        avatarInputEl.click();
      });

      // quando o usu√°rio escolhe uma imagem
      avatarInputEl.addEventListener("change", () => {
        const file = avatarInputEl.files[0];
        if (!file) return;

        // opcional: limitar tamanho/tipo
        if (!file.type.startsWith("image/")) {
          alert("Por favor, selecione uma imagem v√°lida.");
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          const dataUrl = e.target.result;
          accountAvatarEl.style.backgroundImage = `url('${dataUrl}')`;
          accountAvatarEl.textContent = "";
          avatarCustomizado = true; // üëà marca que agora √© foto, n√£o iniciais
        };
        reader.readAsDataURL(file);

        const formData = new FormData();
        formData.append("avatar", file);

        fetch("/api/me/avatar", {
          method: "POST",
          body: formData,
        })
          .then((resp) => {
            if (!resp.ok) {
              console.error("Falha ao enviar avatar:", resp.status);
              // opcional: mostrar toast msg
            }
          })
          .catch((err) => {
            console.error("Erro na requisi√ß√£o de avatar:", err);
          });
      });

      async function abrirPainelConta() {
        accountPanel.style.display = "flex";

        accountNameEl.textContent = "Carregando...";
        accountEmailEl.textContent = "‚Äî";

        // se ainda n√£o foi customizado, mostra "?"
        if (!avatarCustomizado) {
          accountAvatarEl.textContent = "?";
          accountAvatarEl.style.backgroundImage = ""; // gradiente padr√£o do CSS
        }

        try {
          const resp = await fetch("/api/me");
          if (!resp.ok) {
            accountNameEl.textContent = "N√£o foi poss√≠vel carregar seus dados";
            accountEmailEl.textContent = `Status: ${resp.status}`;
            return;
          }

          const user = await resp.json();
          accountNameEl.textContent = user.nome ?? "Usu√°rio sem nome";
          accountEmailEl.textContent = user.email ?? "‚Äî";

          // üëâ S√≥ coloca iniciais se N√ÉO tiver foto customizada
          if (!avatarCustomizado) {
            accountAvatarEl.textContent = initialsFromName(
              user.nome ?? user.email
            );
            accountAvatarEl.style.backgroundImage = "";
          } else {
            // j√° tem foto, garante que o texto fique vazio
            accountAvatarEl.textContent = "";
          }
        } catch (e) {
          console.error("Erro ao carregar /api/me:", e);
          accountNameEl.textContent = "Erro ao carregar suas informa√ß√µes";
          accountEmailEl.textContent = "Tente novamente mais tarde.";
        }

        loadFriendsOverview();
      }

      function fecharPainelConta() {
        accountPanel.style.display = "none";
      }

      closeAccountBtn.addEventListener("click", () => {
        fecharPainelConta();
      });

      // fecha ao clicar fora do card
      accountPanel.addEventListener("click", (e) => {
        if (e.target === accountPanel) {
          fecharPainelConta();
        }
      });

      if (logoutButton) {
        logoutButton.addEventListener("click", async () => {
          logoutButton.disabled = true;
          try {
            const resp = await fetch("/api/auth/logout", {
              method: "POST",
              headers: {
                "X-Requested-With": "XMLHttpRequest",
              },
            });
            if (resp.ok) {
              window.location.href = "/";
            } else {
              alert("N√£o foi poss√≠vel sair. Tente novamente.");
            }
          } catch (err) {
            console.error("Erro ao fazer logout", err);
            alert("Erro de rede ao sair da conta.");
          } finally {
            logoutButton.disabled = false;
          }
        });
      }

      // ---- Edi√ß√£o de nome ----
      editNameBtn.addEventListener("click", () => {
        const currentName = accountNameEl.textContent.trim();
        nameEditInput.value =
          currentName === "Carregando..." || currentName === ""
            ? ""
            : currentName;
        nameEditContainer.classList.remove("hidden");
        nameEditInput.focus();
        nameEditInput.select();
      });

      nameCancelBtn.addEventListener("click", () => {
        nameEditContainer.classList.add("hidden");
      });

      nameSaveBtn.addEventListener("click", async () => {
        const novoNome = nameEditInput.value.trim();
        if (!novoNome) {
          alert("O nome n√£o pode ser vazio.");
          return;
        }

        try {
          const resp = await fetch("/api/me/name", {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ nome: novoNome }),
          });

          if (!resp.ok) {
            console.error("Erro ao atualizar nome:", resp.status);
            alert("N√£o foi poss√≠vel atualizar seu nome. Tente novamente.");
            return;
          }

          const data = await resp.json();
          accountNameEl.textContent = data.nome ?? novoNome;
          nameEditContainer.classList.add("hidden");
        } catch (e) {
          console.error("Erro na requisi√ß√£o de update de nome:", e);
          alert("Ocorreu um erro ao atualizar seu nome.");
        }
      });

      // -------- Mapa + OSM / Overpass --------

      // --------- Elementos da UI ---------
      const coordsDiv = document.getElementById("coords");
      const categoryFilterDiv = document.getElementById("category-filter");
      const radiusSlider = document.getElementById("radius-slider");
      const radiusValue = document.getElementById("radius-value");

      // --------- Estado da Aplica√ß√£o ---------
      let userActualLocation = null;
      let currentSearchCoords = null;
      let allFoundPlaces = [];
      const defaultLat = -22.9068;
      const defaultLon = -43.1729;
      let currentRadius = 1500; // Raio de busca em metros, agora din√¢mico
      const defaultCheckedCategories = new Set([
        "place_of_worship",
        "restaurant",
        "fast_food",
        "cafe",
        "bar",
        "ice_cream",
        "pub",
        "cinema",
        "theatre",
        "nightclub",
        "university",
      ]);

      // Estilo para o c√≠rculo de raio
      const radiusCircleOptions = {
        color: "#000000",
        weight: 2,
        opacity: 1,
        fill: false,
        dashArray: "5, 10",
      };

      // --------- Inicializa√ß√£o do Mapa (Leaflet) ---------
      const map = L.map("map", { zoomControl: false }).setView(
        [defaultLat, defaultLon],
        12
      );
      L.control.zoom({ position: "topright" }).addTo(map);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);
      const markersLayer = L.layerGroup().addTo(map);

      function atualizarCoordsLabel(lat, lon, origem) {
        coordsDiv.textContent = `Localiza√ß√£o (${origem}): ${lat.toFixed(
          5
        )}, ${lon.toFixed(5)}`;
      }

      const userIcon = L.icon({
        iconUrl:
          "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
        shadowUrl:
          "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41],
      });

      const blueCircleIcon = L.divIcon({
        className: "blue-circle-icon",
        html: "<div></div>",
        iconSize: [16, 16],
        iconAnchor: [8, 8],
      });

      // üìå Pino vermelho (marcador de busca), m√≥vel
      let searchMarker = null;
      let locationMarker = null;
      let searchRadiusCircle = null; // C√≠rculo pontilhado do raio

      // --------- Controle Customizado "Home" ---------
      const HomeButton = L.Control.extend({
        options: { position: "topright" },
        onAdd: function (map) {
          const btn = L.DomUtil.create(
            "div",
            "leaflet-bar leaflet-control leaflet-control-custom"
          );
          btn.innerHTML = "üè†";
          L.DomEvent.on(btn, "click", (e) => {
            L.DomEvent.stop(e);
            if (userActualLocation) {
              map.setView([userActualLocation.lat, userActualLocation.lng], 14);
              setSearchMarker(
                userActualLocation.lat,
                userActualLocation.lng,
                "Buscando a partir da sua localiza√ß√£o"
              );
            } else {
              alert(
                "Ainda n√£o foi poss√≠vel obter sua localiza√ß√£o inicial. Tente recarregar a p√°gina."
              );
            }
          });
          return btn;
        },
      });
      map.addControl(new HomeButton());

      // --------- L√≥gica de Eventos do Mapa ---------
      map.on("click", function (e) {
        const { lat, lng } = e.latlng;
        setSearchMarker(lat, lng, "Buscando a partir daqui");
      });

      radiusSlider.addEventListener("input", () => {
        currentRadius = parseInt(radiusSlider.value, 10);
        radiusValue.textContent = `${currentRadius}m`;

        if (searchRadiusCircle) {
          searchRadiusCircle.setRadius(currentRadius);
        }
      });

      radiusSlider.addEventListener("change", () => {
        // A busca √© chamada apenas quando o usu√°rio solta o slider, para evitar muitas requisi√ß√µes
        carregarPlaces();
      });

      categoryFilterDiv.addEventListener("change", () => {
        aplicarFiltroEAtualizarMapa();
      });

      // --------- Fun√ß√µes Principais da L√≥gica de Filtragem ---------
      function setSearchMarker(lat, lon, label) {
        currentSearchCoords = { lat, lon };
        atualizarCoordsLabel(
          `Buscando em: ${lat.toFixed(5)}, ${lon.toFixed(5)}`
        );

        if (searchMarker) {
          searchMarker.setLatLng([lat, lon]);
          searchMarker.setPopupContent(label);
        } else {
          searchMarker = L.marker([lat, lon], { icon: userIcon })
            .addTo(map)
            .bindPopup(label)
            .openPopup();
        }

        // Desenha ou move o c√≠rculo de raio
        if (searchRadiusCircle) {
          searchRadiusCircle.setLatLng([lat, lon]);
          searchRadiusCircle.setRadius(currentRadius);
        } else {
          searchRadiusCircle = L.circle([lat, lon], {
            ...radiusCircleOptions,
            radius: currentRadius,
          }).addTo(map);
        }

        carregarPlaces();
      }

      async function carregarPlaces() {
        if (!currentSearchCoords) return;
        categoryFilterDiv.innerHTML =
          '<span class="loader">Buscando locais...</span>';
        markersLayer.clearLayers();
        const { lat, lon } = currentSearchCoords;
        try {
          const url = `/api/places?lat=${lat}&lon=${lon}&radius=${currentRadius}`;
          const response = await fetch(url);
          if (!response.ok) {
            categoryFilterDiv.innerHTML =
              '<span class="loader">Erro na busca.</span>';
            if (response.status === 401 || response.status === 403) {
              alert("Sess√£o expirada. Por favor, fa√ßa login novamente.");
              window.location.href = "/";
            }
            return;
          }
          allFoundPlaces = await response.json();
          atualizarFiltroCategorias(allFoundPlaces);
          aplicarFiltroEAtualizarMapa();
        } catch (error) {
          console.error("Erro ao carregar places:", error);
          categoryFilterDiv.innerHTML =
            '<span class="loader">Erro na busca.</span>';
        }
      }

      function atualizarFiltroCategorias(places) {
        if (places.length === 0) {
          categoryFilterDiv.innerHTML =
            '<span class="loader">Nenhum local encontrado.</span>';
          return;
        }
        const categories = [...new Set(places.map((p) => p.type))].sort();
        categoryFilterDiv.innerHTML = "<h4>Categorias</h4>";
        categories.forEach((cat) => {
          const id = `cat-${cat}`;
          const item = document.createElement("div");
          item.className = "category-item";
          const labelTraduzida = traducoes[cat] || cat.replace(/_/g, " ");
          const isChecked = defaultCheckedCategories.has(cat) ? "checked" : "";
          item.innerHTML = `
            <input type="checkbox" id="${id}" value="${cat}" ${isChecked}>
            <label for="${id}">${labelTraduzida}</label>
          `;
          categoryFilterDiv.appendChild(item);
        });
      }

      function aplicarFiltroEAtualizarMapa() {
        const selectedCategories = new Set(
          Array.from(categoryFilterDiv.querySelectorAll("input:checked")).map(
            (input) => input.value
          )
        );
        const placesFiltrados = allFoundPlaces.filter((place) =>
          selectedCategories.has(place.type)
        );
        markersLayer.clearLayers();
        placesFiltrados.forEach((place) => {
          const marker = L.marker([place.lat, place.lon]).addTo(markersLayer);
          const tipoTraduzido =
            traducoes[place.type] || place.type.replace(/_/g, " ");

          // Sanitiza o nome do lugar para usar em atributos HTML
          const safeName = place.name
            .replace(/'/g, "\\'")
            .replace(/"/g, "&quot;");

          const favoriteLabel = isPlaceFavorited(place)
            ? "‚≠ê Desfavoritar"
            : "‚≠ê Favoritar";

          const popupContent = `
              <div class="popup-header">${place.name}</div>
              <div class="popup-type">${tipoTraduzido}</div>
              <div class="popup-actions">
                  <button class="popup-btn maps" onclick="abrirGoogleMaps('${safeName}', ${place.lat}, ${place.lon})">üó∫Ô∏è Maps</button>
                  <button class="popup-btn favorite" onclick="favoritarLugar(${place.id}, this)">${favoriteLabel}</button>
              </div>
          `;

          marker.bindPopup(popupContent, {
            className: "custom-popup",
          });
        });
      }

      function normalizeFavoriteName(name) {
        if (!name || !name.trim()) {
          return "(sem nome)";
        }
        return name.trim();
      }

      function favoriteKey(name, lat, lon) {
        return `${normalizeFavoriteName(name).toLowerCase()}|${lat}|${lon}`;
      }

      function favoriteKeyFromPlace(place) {
        return favoriteKey(place.name ?? "", place.lat, place.lon);
      }

      function favoriteKeyFromDto(favorite) {
        if (!favorite) return "";
        return favoriteKey(favorite.name ?? "", favorite.lat, favorite.lon);
      }

      function isPlaceFavorited(place) {
        return favoritePlacesCache.has(favoriteKeyFromPlace(place));
      }

      function addFavoriteToList(favorite) {
        if (!favorite) return;
        const idx = favoritePlacesList.findIndex((f) => f.id === favorite.id);
        if (idx >= 0) {
          favoritePlacesList[idx] = favorite;
        } else {
          favoritePlacesList.push(favorite);
        }
      }

      function removeFavoriteFromListById(favoriteId) {
        favoritePlacesList = favoritePlacesList.filter((fav) => fav.id !== favoriteId);
      }

      async function loadFavoritePlacesCache() {
        try {
          const resp = await fetch("/api/favorites");
          if (!resp.ok) {
            return;
          }
          const data = await resp.json();
          favoritePlacesCache.clear();
          favoritePlacesList = Array.isArray(data) ? data : [];
          favoritePlacesList.forEach((fav) => {
            favoritePlacesCache.set(favoriteKeyFromDto(fav), fav);
          });
          renderFavoriteModalList();
          if (allFoundPlaces.length) {
            aplicarFiltroEAtualizarMapa();
          }
        } catch (err) {
          console.error("Erro ao carregar favoritos:", err);
        }
      }

      function showFeedbackToast(message) {
        if (!feedbackToastEl) return;
        feedbackToastEl.textContent = message;
        feedbackToastEl.classList.add("visible");
        if (feedbackToastTimeout) {
          clearTimeout(feedbackToastTimeout);
        }
        feedbackToastTimeout = setTimeout(() => {
          feedbackToastEl.classList.remove("visible");
        }, 2000);
      }

      // --------- Fun√ß√µes Auxiliares ---------
      function abrirGoogleMaps(nome, lat, lon) {
        let query;
        if (nome && nome.trim() !== "(sem nome)") {
          query = encodeURIComponent(`${nome},${lat},${lon}`);
        } else {
          query = encodeURIComponent(`${lat},${lon}`);
        }
        const url = `https://www.google.com/maps/search/?api=1&query=${query}`;
        window.open(url, "_blank");
      }

      async function favoritarLugar(placeOrId, buttonEl = null) {
        let place;
        if (typeof placeOrId === 'object' && placeOrId !== null) {
          place = placeOrId;
        } else {
          place = allFoundPlaces.find(p => p.id === placeOrId);
        }

        if (!place) {
          showFeedbackToast("Lugar n√£o encontrado.");
          return;
        }

        const key = favoriteKeyFromPlace(place);
        const existingFavorite = favoritePlacesCache.get(key);

        if (existingFavorite) {
          try {
            const resp = await fetch(`/api/favorites/${existingFavorite.id}`, {
              method: "DELETE",
            });
            if (resp.status === 401 || resp.status === 403) {
              alert("Sess√£o expirada. Fa√ßa login novamente.");
              window.location.href = "/";
              return;
            }
            if (!resp.ok) {
              const text = await resp.text();
              showFeedbackToast(text || "N√£o foi poss√≠vel remover o favorito.");
              return;
            }
            favoritePlacesCache.delete(key);
            removeFavoriteFromListById(existingFavorite.id);
            renderFavoriteModalList();
            showFeedbackToast("Lugar removido dos favoritos.");
          } catch (err) {
            console.error("Erro ao remover favorito:", err);
            showFeedbackToast("Erro ao remover favorito.");
            return;
          }
        } else {
          try {
            const resp = await fetch("/api/favorites", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                externalId: String(place.id),
                name: place.name ?? "(sem nome)",
                type: place.type ?? "unknown",
                lat: place.lat,
                lon: place.lon,
                source: place.source || "OSM", 
              }),
            });

            if (resp.status === 401 || resp.status === 403) {
              alert("Sess√£o expirada. Fa√ßa login novamente.");
              window.location.href = "/";
              return;
            }

            if (!resp.ok) {
              const text = await resp.text();
              showFeedbackToast(text || "N√£o foi poss√≠vel favoritar o lugar.");
              return;
            }

            const data = await resp.json();
            favoritePlacesCache.set(key, data);
            addFavoriteToList(data);
            renderFavoriteModalList();
            showFeedbackToast("Lugar salvo nos favoritos!");
          } catch (err) {
            console.error("Erro ao favoritar lugar:", err);
            showFeedbackToast("Erro ao favoritar o lugar.");
            return;
          }
        }

        if (buttonEl) {
          const isFavorited = isPlaceFavorited(place);
          buttonEl.textContent = isFavorited ? "‚≠ê Desfavoritar" : "‚≠ê Favoritar";
          if (buttonEl.classList.contains('favorite')) { // Check if it's the map button
             if (isFavorited) {
                buttonEl.classList.add('favorited');
             } else {
                buttonEl.classList.remove('favorited');
             }
          }
        }
        // Also refresh map markers to update any other open popups for the same place
        aplicarFiltroEAtualizarMapa();
      }

      function atualizarCoordsLabel(texto) {
        coordsDiv.textContent = texto;
      }
      function combinarRole(placeId) {
        alert(
          "Combinar rol√™ no lugar ID " +
            placeId +
            " (futuro: abrir fluxo de grupo/vota√ß√£o)"
        );
      }

      function carregarPosicaoPadrao(motivo) {
        console.warn(motivo);
        map.setView([defaultLat, defaultLon], 12);
        setSearchMarker(defaultLat, defaultLon, "Local padr√£o: Centro do Rio");
      }

      // --------- Fun√ß√£o Principal de Inicializa√ß√£o ---------
      async function inicializarMapa() {
        categoryFilterDiv.innerHTML =
          '<span class="loader">Mova o pino para buscar...</span>';
        if (!navigator.geolocation) {
          carregarPosicaoPadrao("Geolocaliza√ß√£o n√£o suportada no navegador.");
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const userLat = pos.coords.latitude;
            const userLon = pos.coords.longitude;
            userActualLocation = { lat: userLat, lng: userLon };
            map.setView([userLat, userLon], 14);
            if (locationMarker) locationMarker.remove();
            locationMarker = L.marker([userLat, userLon], {
              icon: blueCircleIcon,
              zIndexOffset: -100,
            }).addTo(map);
            setSearchMarker(
              userLat,
              userLon,
              "Buscando a partir da sua localiza√ß√£o"
            );
          },
          (err) => {
            atualizarCoordsLabel("N√£o foi poss√≠vel obter sua localiza√ß√£o.");
            carregarPosicaoPadrao(`Erro ao obter localiza√ß√£o: ${err.message}`);
          },
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
        );
      }

      inicializarMapa();

      // --------- Overlay de CHAT (lista de amigos + conversa) ---------
      const chatOverlay = document.getElementById("chat-overlay");
      const chatAppContainer = document.getElementById("chat-app-container");
      const chatCloseBtn = document.getElementById("chat-close-btn");
      const contactSearchInput = document.getElementById("contact-search");
      const contactListEl = document.getElementById("contact-list");
      const chatHeaderTitleEl = document.getElementById("chat-header-title");
      const chatHeaderSubtitleEl = document.getElementById(
        "chat-header-subtitle"
      );
      const chatVotingPanelEl = document.getElementById("chat-voting-panel");
      const messagesContainerEl = document.getElementById("messages-container");
      const chatInputEl = document.getElementById("chat-input");
      const chatSendButtonEl = document.getElementById("chat-send-button");
      const chatShareFavoriteBtn = document.getElementById(
        "chat-share-favorite"
      );
      const chatCreateGroupBtn = document.getElementById(
        "btn-open-create-group"
      );
      const favoriteModalOverlay = document.getElementById(
        "favorite-modal-overlay"
      );
      const favoriteModalListEl = document.getElementById("favorite-modal-list");
      const favoriteModalCloseBtn = document.getElementById(
        "favorite-modal-close"
      );
      const votingModalOverlay = document.getElementById(
        "voting-modal-overlay"
      );
      const votingModalTitleEl = document.getElementById("voting-modal-title");
      const votingModalHintEl = document.getElementById("voting-modal-hint");
      const votingModalBodyEl = document.getElementById("voting-modal-body");
      const votingModalCloseBtn = document.getElementById("voting-modal-close");
      const votingModalCancelBtn = document.getElementById("voting-modal-cancel");
      const votingModalPrimaryBtn = document.getElementById(
        "voting-modal-primary"
      );
      const groupModalOverlay = document.getElementById(
        "group-modal-overlay"
      );
      const groupModalCloseBtn = document.getElementById("group-modal-close");
      const groupModalCancelBtn = document.getElementById("group-modal-cancel");
      const groupModalCreateBtn = document.getElementById("group-modal-create");
      const groupNameInput = document.getElementById("group-name-input");
      const groupFriendsListEl = document.getElementById("group-friends-list");

      let chatRooms = [];
      let chatContacts = [];
      const chatMessagesCache = new Map();
      let currentRoomId = null;
      let currentUserProfile = null;
      let activeVotingSession = null;
      let votingModalMode = null;
      let votingFavoriteSelection = [];
      let votingOptionRanking = [];
      let groupModalSelectedIds = new Set();

      async function ensureCurrentUserProfile() {
        if (currentUserProfile) return;
        try {
          const resp = await fetch("/api/me");
          if (resp.ok) {
            currentUserProfile = await resp.json();
          }
        } catch (err) {
          console.error("Erro ao obter usu√°rio logado:", err);
        }
      }

      async function fetchChatRooms() {
        if (!contactListEl) return;
        try {
          const resp = await fetch("/api/chat/rooms");
          if (resp.status === 401 || resp.status === 403) {
            alert("Sess√£o expirada. Fa√ßa login novamente.");
            window.location.href = "/";
            return;
          }
          if (!resp.ok) {
            console.error("Erro ao carregar salas de chat:", resp.status);
            return;
          }
          chatRooms = await resp.json();
          renderContactList(contactSearchInput ? contactSearchInput.value : "");
        } catch (err) {
          console.error("Erro ao buscar salas:", err);
        }
      }

      async function fetchChatContacts() {
        try {
          const resp = await fetch("/api/friends");
          if (resp.status === 401 || resp.status === 403) {
            alert("Sess√£o expirada. Fa√ßa login novamente.");
            window.location.href = "/";
            return;
          }
          if (!resp.ok) {
            console.error("Erro ao carregar amigos para o chat:", resp.status);
            return;
          }
          const data = await resp.json();
          chatContacts = Array.isArray(data.friends) ? data.friends : [];
          renderContactList(contactSearchInput ? contactSearchInput.value : "");
        } catch (err) {
          console.error("Erro ao buscar contatos do chat:", err);
        }
      }

      async function fetchActiveVotingSession(roomId) {
        if (!roomId) {
          activeVotingSession = null;
          updateVotingPanel();
          return;
        }
        try {
          const resp = await fetch(`/api/voting/rooms/${roomId}/current`);
          if (resp.status === 401 || resp.status === 403) {
            alert("Sess√£o expirada. Fa√ßa login novamente.");
            window.location.href = "/";
            return;
          }
          if (resp.status === 404) {
            activeVotingSession = null;
            updateVotingPanel();
            return;
          }
          if (!resp.ok) {
            console.error("Erro ao carregar sess√£o de vota√ß√£o:", resp.status);
            return;
          }
          const data = await resp.json();
          activeVotingSession = data || null;
          if (activeVotingSession && activeVotingSession.options) {
            activeVotingSession.options = activeVotingSession.options.map(
              (opt) => ({
                ...opt,
                place: opt.place || opt.favoritePlace,
              })
            );
          }
          updateVotingPanel();
        } catch (err) {
          console.error("Erro ao buscar vota√ß√£o:", err);
        }
      }

      async function fetchChatContacts() {
        try {
          const resp = await fetch("/api/friends");
          if (resp.status === 401 || resp.status === 403) {
            alert("Sess√£o expirada. Fa√ßa login novamente.");
            window.location.href = "/";
            return;
          }
          if (!resp.ok) {
            console.error("Erro ao carregar amigos para o chat:", resp.status);
            return;
          }
          const data = await resp.json();
          chatContacts = Array.isArray(data.friends) ? data.friends : [];
          renderContactList(contactSearchInput ? contactSearchInput.value : "");
        } catch (err) {
          console.error("Erro ao buscar contatos do chat:", err);
        }
      }

      async function abrirChat() {
        if (!chatOverlay) return;
        chatOverlay.style.display = "flex";
        await ensureCurrentUserProfile();
        await fetchChatRooms();
        await fetchChatContacts();
        if (!currentRoomId && chatRooms.length > 0) {
          await selecionarContato(chatRooms[0].id);
        } else {
          renderMessages();
          await fetchActiveVotingSession(currentRoomId);
          updateVotingPanel();
        }
        chatInputEl?.focus();
      }

      function fecharChat() {
        if (chatOverlay) {
          chatOverlay.style.display = "none";
        }
      }

      chatCloseBtn?.addEventListener("click", () => fecharChat());

      chatOverlay?.addEventListener("click", (e) => {
        if (e.target === chatOverlay) {
          fecharChat();
        }
      });

      function findDirectRoomForFriend(friendId) {
        return chatRooms.find((room) => {
          if (room.type !== "DIRECT") return false;
          if (!Array.isArray(room.participants)) return false;
          return room.participants.some((participant) => participant.id === friendId);
        });
      }

      function renderContactList(filterText = "") {
        if (!contactListEl) return;
        contactListEl.innerHTML = "";
        const term = filterText.trim().toLowerCase();

        const fragment = document.createDocumentFragment();
        let hasEntries = false;

        const filteredRooms = chatRooms.filter((room) => {
          const display = (room.displayName || room.name || "Chat").toLowerCase();
          return !term || display.includes(term);
        });

        filteredRooms.forEach((room) => {
          hasEntries = true;
          const li = document.createElement("li");
          li.className = "contact-item";
          li.dataset.roomId = room.id;

          if (room.id === currentRoomId) {
            li.classList.add("active");
          }

          const avatar = document.createElement("div");
          avatar.className = "contact-avatar";
          const initials = (room.displayName || room.name || "J")
            .split(" ")
            .map((part) => part.charAt(0).toUpperCase())
            .slice(0, 2)
            .join("");
          avatar.textContent = initials;

          const info = document.createElement("div");
          info.className = "contact-info";

          const spanName = document.createElement("div");
          spanName.className = "contact-name";
          spanName.textContent = room.displayName || room.name || "Chat";
          info.appendChild(spanName);

          if (room.type === 'GROUP' && Array.isArray(room.participants)) {
            const subtitle = document.createElement("div");
            subtitle.className = "contact-subtitle";
            subtitle.textContent = room.participants
                .map(p => p.nome.split(' ')[0]) // Pega o primeiro nome
                .join(', ');
            info.appendChild(subtitle);
          }

          li.appendChild(avatar);
          li.appendChild(info);

          li.addEventListener("click", () => {
            selecionarContato(room.id).catch((err) =>
              console.error("Erro ao selecionar sala:", err)
            );
          });

          fragment.appendChild(li);
        });

        const availableFriends = chatContacts.filter((friend) => {
          const alreadyHasRoom = !!findDirectRoomForFriend(friend.id);
          if (alreadyHasRoom) {
            return false;
          }
          return !term || friend.nome.toLowerCase().includes(term);
        });

        availableFriends.forEach((friend) => {
          const li = document.createElement("li");
          li.className = "contact-item";
          li.dataset.friendId = friend.id;

          const avatar = document.createElement("div");
          avatar.className = "contact-avatar";
          avatar.textContent = (friend.nome || "?").charAt(0).toUpperCase();

          const spanName = document.createElement("span");
          spanName.textContent = friend.nome || "Amigo";

          li.appendChild(avatar);
          li.appendChild(spanName);

          li.addEventListener("click", () => {
            startDirectChatWithFriend(friend.id);
          });

          fragment.appendChild(li);
          hasEntries = true;
        });

        if (!hasEntries) {
          const empty = document.createElement("li");
          empty.className = "contact-item";
          empty.style.justifyContent = "center";
          empty.textContent = term
            ? "Nenhum resultado para sua busca."
            : "Nenhuma conversa dispon√≠vel. Adicione amigos para conversar.";
          fragment.appendChild(empty);
        }

        contactListEl.appendChild(fragment);
      }

      async function ensureMessagesForRoom(roomId) {
        if (chatMessagesCache.has(roomId)) return;
        try {
          const resp = await fetch(`/api/chat/rooms/${roomId}/messages`);
          if (resp.status === 401 || resp.status === 403) {
            alert("Sess√£o expirada. Fa√ßa login novamente.");
            window.location.href = "/";
            return;
          }
          if (!resp.ok) {
            console.error("Erro ao carregar mensagens:", resp.status);
            return;
          }
          const data = await resp.json();
          chatMessagesCache.set(roomId, data);
        } catch (err) {
          console.error("Erro ao buscar mensagens:", err);
        }
      }

      async function selecionarContato(roomId) {
        currentRoomId = roomId;
        renderContactList(contactSearchInput ? contactSearchInput.value : "");
        await ensureMessagesForRoom(roomId);
        await fetchActiveVotingSession(roomId);
        renderMessages();
        updateVotingPanel();
      }

      async function startDirectChatWithFriend(friendId) {
        try {
          const resp = await fetch("/api/chat/rooms/direct", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ targetUserId: friendId }),
          });

          if (resp.status === 401 || resp.status === 403) {
            alert("Sess√£o expirada. Fa√ßa login novamente.");
            window.location.href = "/";
            return;
          }

          if (!resp.ok) {
            const text = await resp.text();
            showFeedbackToast(text || "N√£o foi poss√≠vel iniciar a conversa.");
            return;
          }

          const room = await resp.json();
          const exists = chatRooms.some((r) => r.id === room.id);
          if (!exists) {
            chatRooms.push(room);
          }
          await selecionarContato(room.id);
        } catch (err) {
          console.error("Erro ao criar chat direto:", err);
          showFeedbackToast("Erro ao abrir conversa com o amigo.");
        }
      }

      function renderMessages() {
        if (!messagesContainerEl) return;
        messagesContainerEl.innerHTML = "";

        if (!currentRoomId) {
          chatHeaderTitleEl.textContent = "Selecione um amigo";
          chatHeaderSubtitleEl.textContent = "A conversa aparece aqui";
          return;
        }

        const room = chatRooms.find((r) => r.id === currentRoomId);
        const msgs = chatMessagesCache.get(currentRoomId) || [];

        chatHeaderTitleEl.textContent = room
          ? room.displayName || room.name
          : "Chat";
        
        if (room && room.type === 'GROUP' && Array.isArray(room.participants)) {
            chatHeaderSubtitleEl.textContent = room.participants
                .map(p => p.nome.split(' ')[0])
                .join(', ');
        } else {
            chatHeaderSubtitleEl.textContent = "Converse sobre o pr√≥ximo rol√™";
        }

        if (!msgs.length) {
          const empty = document.createElement("p");
          empty.style.textAlign = "center";
          empty.style.color = "#9ca3af";
          empty.style.fontSize = "0.8rem";
          empty.textContent = "Nenhuma mensagem ainda.";
          messagesContainerEl.appendChild(empty);
          return;
        }

        msgs.forEach((msg) => {
          const isMe =
            currentUserProfile &&
            msg.sender &&
            msg.sender.id === currentUserProfile.id;

          const row = document.createElement("div");
          row.className = "message-row " + (isMe ? "me" : "other");

          const bubble = document.createElement("div");
          bubble.className = "message-bubble";
          const textContent = msg.content && msg.content.trim().length > 0
            ? msg.content
            : msg.favoritePlace
            ? "Compartilhou um lugar favorito"
            : "";
          if (textContent) {
            const textNode = document.createElement("div");
            textNode.textContent = textContent;
            bubble.appendChild(textNode);
          }

          if (msg.favoritePlace) {
            const fav = msg.favoritePlace;
            const favCard = document.createElement("div");
            favCard.className = "favorite-share-card";
            const title = document.createElement("strong");
            title.textContent = fav.name ?? "(sem nome)";
            const type = document.createElement("span");
            const label = traducoes[fav.type] || fav.type || "Lugar";
            type.textContent = label;

            const buttonsContainer = document.createElement("div");
            buttonsContainer.className = "favorite-share-card-buttons";

            const openBtn = document.createElement("button");
            openBtn.type = "button";
            openBtn.className = "favorite-share-card-button maps";
            openBtn.textContent = "Abrir em Maps";
            openBtn.addEventListener("click", () => {
              abrirGoogleMaps(fav.name, fav.lat, fav.lon);
            });

            const favoriteBtn = document.createElement("button");
            favoriteBtn.type = "button";
            favoriteBtn.className = "favorite-share-card-button favorite";
            if (isPlaceFavorited(fav)) {
              favoriteBtn.classList.add("favorited");
              favoriteBtn.textContent = "‚≠ê Desfavoritar";
            } else {
              favoriteBtn.textContent = "‚≠ê Favoritar";
            }
            favoriteBtn.addEventListener("click", async (e) => {
                e.stopPropagation();
                await favoritarLugar(fav, favoriteBtn);
            });

            favCard.appendChild(title);
            favCard.appendChild(type);
            buttonsContainer.appendChild(openBtn);
            buttonsContainer.appendChild(favoriteBtn);
            favCard.appendChild(buttonsContainer);
            bubble.appendChild(favCard);
          }

          const meta = document.createElement("span");
          meta.className = "message-meta";
          const when = msg.createdAt
            ? new Date(msg.createdAt).toLocaleTimeString("pt-BR", {
                hour: "2-digit",
                minute: "2-digit",
              })
            : "";
          const senderLabel = isMe
            ? "Voc√™"
            : msg.sender && msg.sender.nome
            ? msg.sender.nome
            : "Contato";
          meta.textContent = `${senderLabel} ‚Ä¢ ${when}`;

          bubble.appendChild(meta);
          row.appendChild(bubble);
          messagesContainerEl.appendChild(row);
        });

        messagesContainerEl.scrollTop = messagesContainerEl.scrollHeight;
      }

      function updateVotingPanel() {
        if (!chatVotingPanelEl) return;
        const room = chatRooms.find((r) => r.id === currentRoomId);
        if (!room || room.type !== "GROUP") {
          chatVotingPanelEl.classList.add("hidden");
          chatVotingPanelEl.innerHTML = "";
          return;
        }

        chatVotingPanelEl.classList.remove("hidden");
        const isAdmin =
          room.adminId && currentUserProfile
            ? room.adminId === currentUserProfile.id
            : false;

        let html = "";

        if (!activeVotingSession) {
          html += `<span class="voting-status-pill">Sem vota√ß√£o ativa</span>`;
          if (isAdmin) {
            html += `<div class="voting-panel-actions"><button id="btn-open-create-voting">Iniciar rol√™ / vota√ß√£o</button></div>`;
          } else {
            html += `<p style="margin:0;font-size:0.78rem;color:#94a3b8;">Aguarde o admin iniciar uma vota√ß√£o.</p>`;
          }
        } else {
          const statusLabel =
            activeVotingSession.status === "OPEN"
              ? "Vota√ß√£o em andamento"
              : "Vota√ß√£o encerrada";
          html += `<span class="voting-status-pill">${statusLabel}</span>`;

          if (
            activeVotingSession.options &&
            activeVotingSession.options.length
          ) {
            html += `<ul class="voting-options-list">`;
            activeVotingSession.options.forEach((opt, idx) => {
              const placeName = opt.place?.name ?? "(sem nome)";
              html += `<li>${idx + 1}. ${placeName}</li>`;
            });
            html += `</ul>`;
          }

          if (activeVotingSession.status === "OPEN") {
            let hasVoted = activeVotingSession.myVote && activeVotingSession.myVote.length > 0;
            let voteButtonText = hasVoted ? "‚úî Voto registrado (Ver/Alterar)" : "Ordenar lugares e votar";
            let voteButtonClass = hasVoted ? "secondary" : "";

            html += `<div class="voting-panel-actions">`;
            html += `<button id="btn-open-vote-modal" class="${voteButtonClass}">${voteButtonText}</button>`;
            if (isAdmin) {
              html += `<button class="secondary" id="btn-close-voting">Encerrar vota√ß√£o</button>`;
            }
            html += `</div>`;
          } else if (activeVotingSession.winningOption) {
            const winnerName =
              activeVotingSession.winningOption.place?.name ?? "(sem nome)";
            html += `<p style="margin:0;font-size:0.8rem;color:#cbd5f5;">Lugar escolhido: <strong>${winnerName}</strong></p>`;
            if (isAdmin) {
              html += `<div class="voting-panel-actions"><button id="btn-open-create-voting">Iniciar nova vota√ß√£o</button></div>`;
            }
          } else {
            html += `<p style="margin:0;font-size:0.8rem;color:#cbd5f5;">Nenhum vencedor definido.</p>`;
            if (isAdmin) {
              html += `<div class="voting-panel-actions"><button id="btn-open-create-voting">Iniciar nova vota√ß√£o</button></div>`;
            }
          }
        }

        chatVotingPanelEl.innerHTML = html;

        const openCreateBtn = document.getElementById("btn-open-create-voting");
        openCreateBtn?.addEventListener("click", () => openVotingModalCreate());

        const openVoteBtn = document.getElementById("btn-open-vote-modal");
        openVoteBtn?.addEventListener("click", () => openVotingModalVote());

        const closeVotingBtn = document.getElementById("btn-close-voting");
        closeVotingBtn?.addEventListener("click", () => encerrarVotacao());
      }

      function openVotingModalCreate() {
        if (!favoritePlacesList.length) {
          showFeedbackToast("Voc√™ ainda n√£o favoritou lugares.");
          return;
        }
        votingModalMode = "CREATE";
        votingFavoriteSelection = favoritePlacesList.slice(
          0,
          Math.min(3, favoritePlacesList.length)
        );
        renderVotingModal();
        votingModalOverlay?.classList.add("visible");
      }

      function openVotingModalVote() {
        if (!activeVotingSession || !activeVotingSession.options) {
          showFeedbackToast("Nenhuma vota√ß√£o ativa.");
          return;
        }
        votingModalMode = "VOTE";

        const optionsCopy = activeVotingSession.options.map((opt) => ({ ...opt }));

        if (activeVotingSession.myVote && activeVotingSession.myVote.length > 0) {
            const orderMap = new Map(activeVotingSession.myVote.map((id, index) => [id, index]));
            optionsCopy.sort((a, b) => {
                const rankA = orderMap.has(a.id) ? orderMap.get(a.id) : Infinity;
                const rankB = orderMap.has(b.id) ? orderMap.get(b.id) : Infinity;
                return rankA - rankB;
            });
        }
        
        votingOptionRanking = optionsCopy;
        renderVotingModal();
        votingModalOverlay?.classList.add("visible");
      }

      function closeVotingModal() {
        votingModalOverlay?.classList.remove("visible");
        votingModalMode = null;
      }

      function renderVotingModal() {
        if (!votingModalBodyEl) return;
        votingModalBodyEl.innerHTML = "";

        if (votingModalMode === "CREATE") {
          votingModalTitleEl.textContent = "Iniciar rol√™ / vota√ß√£o";
          votingModalHintEl.textContent = "Escolha ao menos dois lugares favoritos para incluir na vota√ß√£o.";
          votingModalPrimaryBtn.textContent = "Iniciar vota√ß√£o";

          // Lista de Favoritos Dispon√≠veis
          const availableWrapper = document.createElement("div");
          availableWrapper.innerHTML = "<h4 style='margin:0 0 6px 0;font-size:0.85rem;color:#93c5fd;'>Adicionar da sua lista de favoritos</h4>";
          const availableList = document.createElement("div");
          availableList.className = "voting-selection-list";
          const selectedIds = new Set(votingFavoriteSelection.map((fav) => fav.id));
          
          const availableFavorites = favoritePlacesList.filter(
            (fav) => !selectedIds.has(fav.id)
          );

          if (!availableFavorites.length) {
            availableList.innerHTML = `<p style="margin:0;font-size:0.78rem;color:#94a3b8;">Todos os seus favoritos j√° est√£o na sele√ß√£o.</p>`;
          } else {
            availableFavorites.forEach((fav) => {
              const row = document.createElement("div");
              row.className = "favorite-item-row";
              const info = document.createElement("div");
              info.className = "favorite-item-info";
              info.innerHTML = `<strong>${fav.name ?? "(sem nome)"}</strong><span>${traducoes[fav.type] || fav.type || "Lugar"}</span>`;
              const addBtn = document.createElement("button");
              addBtn.type = "button";
              addBtn.textContent = "Adicionar";
              addBtn.style.padding = "4px 10px";
              addBtn.addEventListener("click", () => {
                votingFavoriteSelection.push(fav);
                renderVotingModal();
              });
              row.appendChild(info);
              row.appendChild(addBtn);
              availableList.appendChild(row);
            });
          }
          availableWrapper.appendChild(availableList);
          votingModalBodyEl.appendChild(availableWrapper);

          // Lista de Lugares Selecionados (sem ordena√ß√£o)
          const selectedWrapper = document.createElement("div");
          selectedWrapper.innerHTML = "<h4 style='margin:12px 0 6px 0;font-size:0.85rem;color:#93c5fd;'>Selecionados para o Rol√™</h4>";
          const selectedList = document.createElement("div");
          selectedList.className = "voting-selection-list";
          if (!votingFavoriteSelection.length) {
            selectedList.innerHTML = `<p style="margin:0;font-size:0.78rem;color:#94a3b8;">Adicione lugares da lista acima.</p>`;
          } else {
            votingFavoriteSelection.forEach((fav, index) => {
              const item = document.createElement("div");
              item.className = "voting-selection-item";
              const info = document.createElement("strong");
              info.textContent = `${fav.name ?? "(sem nome)"}`;
              
              const removeBtn = document.createElement("button");
              removeBtn.textContent = "Remover";
              removeBtn.className = "remove-btn"; // Apply the new class
              removeBtn.addEventListener("click", () => {
                votingFavoriteSelection.splice(index, 1);
                renderVotingModal();
              });

              item.appendChild(info);
              item.appendChild(removeBtn);
              selectedList.appendChild(item);
            });
          }
          selectedWrapper.appendChild(selectedList);
          votingModalBodyEl.appendChild(selectedWrapper);

        } else if (votingModalMode === "VOTE") {
          votingModalTitleEl.textContent = "Ordenar lugares para o rol√™";
          votingModalHintEl.textContent =
            "Arrume as prefer√™ncias de cima para baixo e envie seu voto.";
          votingModalPrimaryBtn.textContent = "Enviar ranking";

          const list = document.createElement("div");
          list.className = "voting-selection-list";
          votingOptionRanking.forEach((opt, index) => {
            const item = document.createElement("div");
            item.className = "voting-selection-item";
            const info = document.createElement("strong");
            info.textContent = `${index + 1}. ${
              opt.place?.name ?? "(sem nome)"
            }`;
            item.appendChild(info);
            const controls = document.createElement("div");
            controls.className = "voting-selection-controls";
            const upBtn = document.createElement("button");
            upBtn.textContent = "‚Üë";
            upBtn.disabled = index === 0;
            upBtn.addEventListener("click", () =>
              moveVotingOption(index, -1)
            );
            const downBtn = document.createElement("button");
            downBtn.textContent = "‚Üì";
            downBtn.disabled = index === votingOptionRanking.length - 1;
            downBtn.addEventListener("click", () => moveVotingOption(index, 1));
            controls.appendChild(upBtn);
            controls.appendChild(downBtn);
            item.appendChild(controls);
            list.appendChild(item);
          });
          votingModalBodyEl.appendChild(list);
        }
      }

      function moveVotingOption(index, direction) {
        const target = index + direction;
        if (
          target < 0 ||
          target >= votingOptionRanking.length ||
          target === index
        ) {
          return;
        }
        const [item] = votingOptionRanking.splice(index, 1);
        votingOptionRanking.splice(target, 0, item);
        renderVotingModal();
      }

      async function submitVotingModal() {
        if (votingModalMode === "CREATE") {
          await submitCreateVoting();
        } else if (votingModalMode === "VOTE") {
          await submitRankingVote();
        }
      }

      async function submitCreateVoting() {
        if (!currentRoomId) {
          showFeedbackToast("Selecione um grupo.");
          return;
        }
        if (!votingFavoriteSelection || votingFavoriteSelection.length < 2) {
          showFeedbackToast("Escolha ao menos dois lugares.");
          return;
        }
        const ids = votingFavoriteSelection.map((fav) => fav.id);
        try {
          const resp = await fetch("/api/voting/sessions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              roomId: currentRoomId,
              favoritePlaceIds: ids,
            }),
          });
          if (resp.status === 401 || resp.status === 403) {
            alert("Sess√£o expirada. Fa√ßa login novamente.");
            window.location.href = "/";
            return;
          }
          if (!resp.ok) {
            const text = await resp.text();
            showFeedbackToast(text || "N√£o foi poss√≠vel iniciar a vota√ß√£o.");
            return;
          }
          closeVotingModal();
          await fetchActiveVotingSession(currentRoomId);
        } catch (err) {
          console.error("Erro ao iniciar vota√ß√£o:", err);
          showFeedbackToast("Erro ao iniciar vota√ß√£o.");
        }
      }

      async function submitRankingVote() {
        if (!activeVotingSession) {
          showFeedbackToast("Nenhuma vota√ß√£o ativa.");
          return;
        }
        const orderedIds = votingOptionRanking.map((opt) => opt.id);
        try {
          const resp = await fetch(
            `/api/voting/sessions/${activeVotingSession.id}/votes`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                orderedOptionIds: orderedIds,
              }),
            }
          );
          if (resp.status === 401 || resp.status === 403) {
            alert("Sess√£o expirada. Fa√ßa login novamente.");
            window.location.href = "/";
            return;
          }
          if (!resp.ok) {
            const text = await resp.text();
            showFeedbackToast(text || "N√£o foi poss√≠vel registrar o voto.");
            return;
          }
          closeVotingModal();
          showFeedbackToast("Voto registrado!");
          await fetchActiveVotingSession(currentRoomId); // Re-fetch session state to update UI
        } catch (err) {
          console.error("Erro ao registrar voto:", err);
          showFeedbackToast("Erro ao registrar voto.");
        }
      }

      async function encerrarVotacao() {
        if (!activeVotingSession) {
          return;
        }
        try {
          const resp = await fetch(
            `/api/voting/sessions/${activeVotingSession.id}/close`,
            { method: "POST" }
          );
          if (resp.status === 401 || resp.status === 403) {
            alert("Sess√£o expirada. Fa√ßa login novamente.");
            window.location.href = "/";
            return;
          }
          if (!resp.ok) {
            const text = await resp.text();
            showFeedbackToast(text || "N√£o foi poss√≠vel encerrar a vota√ß√£o.");
            return;
          }
          activeVotingSession = await resp.json();
          if (activeVotingSession && activeVotingSession.options) {
            activeVotingSession.options = activeVotingSession.options.map(
              (opt) => ({
                ...opt,
                place: opt.place || opt.favoritePlace,
              })
            );
          }
          updateVotingPanel();
        } catch (err) {
          console.error("Erro ao encerrar vota√ß√£o:", err);
          showFeedbackToast("Erro ao encerrar vota√ß√£o.");
        }
      }

      async function enviarMensagemAtual(contentOverride = null, favoritePlaceId = null) {
        if (!currentRoomId) {
          showFeedbackToast("Selecione uma conversa.");
          return;
        }

        const text = contentOverride ?? chatInputEl.value.trim();
        if (!text && !favoritePlaceId) {
          return;
        }

        try {
          const resp = await fetch(`/api/chat/rooms/${currentRoomId}/messages`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              content: text,
              favoritePlaceId,
            }),
          });

          if (resp.status === 401 || resp.status === 403) {
            alert("Sess√£o expirada. Fa√ßa login novamente.");
            window.location.href = "/";
            return;
          }

          if (!resp.ok) {
            const errorText = await resp.text();
            showFeedbackToast(errorText || "N√£o foi poss√≠vel enviar a mensagem.");
            return;
          }

          const message = await resp.json();
          const list = chatMessagesCache.get(currentRoomId) || [];
          list.push(message);
          chatMessagesCache.set(currentRoomId, list);

          if (contentOverride === null) {
            chatInputEl.value = "";
          }
          renderMessages();
        } catch (err) {
          console.error("Erro ao enviar mensagem:", err);
          showFeedbackToast("Erro ao enviar mensagem.");
        }
      }

      chatSendButtonEl?.addEventListener("click", () =>
        enviarMensagemAtual()
      );

      chatInputEl?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          enviarMensagemAtual();
        }
      });

      contactSearchInput?.addEventListener("input", (e) => {
        renderContactList(e.target.value);
      });

      function openCreateGroupModal() {
        if (!groupModalOverlay) return;
        groupNameInput.value = "";
        groupModalSelectedIds = new Set();
        renderGroupFriendsList();
        groupModalOverlay.classList.add("visible");
      }

      function closeCreateGroupModal() {
        groupModalOverlay?.classList.remove("visible");
      }

      function renderGroupFriendsList(filter = "") {
        if (!groupFriendsListEl) return;
        groupFriendsListEl.innerHTML = "";
        const term = filter.trim().toLowerCase();
        const friends = chatContacts.filter((friend) => {
          if (!term) return true;
          return friend.nome?.toLowerCase().includes(term);
        });

        if (!friends.length) {
          const empty = document.createElement("p");
          empty.style.margin = "0";
          empty.style.fontSize = "0.8rem";
          empty.style.color = "#94a3b8";
          empty.textContent = "Nenhum amigo dispon√≠vel.";
          groupFriendsListEl.appendChild(empty);
          return;
        }

        friends.forEach((friend) => {
          const row = document.createElement("label");
          row.className = "group-friend-item";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = groupModalSelectedIds.has(friend.id);
          checkbox.addEventListener("change", () => {
            if (checkbox.checked) {
              groupModalSelectedIds.add(friend.id);
            } else {
              groupModalSelectedIds.delete(friend.id);
            }
          });
          const span = document.createElement("span");
          span.textContent = friend.nome || "Amigo";
          row.appendChild(checkbox);
          row.appendChild(span);
          groupFriendsListEl.appendChild(row);
        });
      }

      async function submitCreateGroup() {
        if (!groupModalOverlay) return;
        const name = groupNameInput.value.trim();
        if (!name) {
          showFeedbackToast("Informe um nome para o grupo.");
          return;
        }
        if (!groupModalSelectedIds.size) {
          showFeedbackToast("Selecione pelo menos um amigo.");
          return;
        }
        try {
          const resp = await fetch("/api/chat/rooms/group", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name,
              participantIds: Array.from(groupModalSelectedIds),
            }),
          });
          if (resp.status === 401 || resp.status === 403) {
            alert("Sess√£o expirada. Fa√ßa login novamente.");
            window.location.href = "/";
            return;
          }
          if (!resp.ok) {
            const text = await resp.text();
            showFeedbackToast(text || "N√£o foi poss√≠vel criar o grupo.");
            return;
          }
          const room = await resp.json();
          const exists = chatRooms.some((r) => r.id === room.id);
          if (!exists) {
            chatRooms.push(room);
          }
          closeCreateGroupModal();
          renderContactList(contactSearchInput ? contactSearchInput.value : "");
          await selecionarContato(room.id);
          showFeedbackToast("Grupo criado!");
        } catch (err) {
          console.error("Erro ao criar grupo:", err);
          showFeedbackToast("Erro ao criar grupo.");
        }
      }

      votingModalPrimaryBtn?.addEventListener("click", () =>
        submitVotingModal()
      );
      votingModalCancelBtn?.addEventListener("click", () => closeVotingModal());
      votingModalCloseBtn?.addEventListener("click", () => closeVotingModal());
      votingModalOverlay?.addEventListener("click", (event) => {
        if (event.target === votingModalOverlay) {
          closeVotingModal();
        }
      });

      chatCreateGroupBtn?.addEventListener("click", () => openCreateGroupModal());
      groupModalCloseBtn?.addEventListener("click", () =>
        closeCreateGroupModal()
      );
      groupModalCancelBtn?.addEventListener("click", () =>
        closeCreateGroupModal()
      );
      groupModalCreateBtn?.addEventListener("click", () =>
        submitCreateGroup()
      );
      groupModalOverlay?.addEventListener("click", (event) => {
        if (event.target === groupModalOverlay) {
          closeCreateGroupModal();
        }
      });

      function renderFavoriteModalList() {
        if (!favoriteModalListEl) return;
        favoriteModalListEl.innerHTML = "";

        if (!favoritePlacesList.length) {
          const empty = document.createElement("p");
          empty.className = "favorite-empty";
          empty.textContent = "Nenhum favorito salvo.";
          favoriteModalListEl.appendChild(empty);
          return;
        }

        favoritePlacesList
          .slice()
          .sort((a, b) =>
            (a.name || "").localeCompare(b.name || "", "pt-BR", {
              sensitivity: "base",
            })
          )
          .forEach((favorite) => {
            const row = document.createElement("div");
            row.className = "favorite-item-row";

            const info = document.createElement("div");
            info.className = "favorite-item-info";
            const title = document.createElement("strong");
            title.textContent = favorite.name ?? "(sem nome)";
            const type = document.createElement("span");
            type.textContent = traducoes[favorite.type] || favorite.type || "Lugar";
            info.appendChild(title);
            info.appendChild(type);

            const sendBtn = document.createElement("button");
            sendBtn.type = "button";
            sendBtn.textContent = "Enviar";
            sendBtn.addEventListener("click", () => {
              closeFavoriteModal();
              sendFavoritePlaceInCurrentChat(favorite);
            });

            row.appendChild(info);
            row.appendChild(sendBtn);
            favoriteModalListEl.appendChild(row);
          });
      }

      function openFavoriteModal() {
        if (!favoriteModalOverlay) return;
        if (!favoritePlacesList.length) {
          showFeedbackToast("Voc√™ ainda n√£o favoritou lugares.");
          return;
        }

        renderFavoriteModalList();
        favoriteModalOverlay.classList.add("visible");
      }

      function closeFavoriteModal() {
        favoriteModalOverlay?.classList.remove("visible");
      }

      function sendFavoritePlaceInCurrentChat(favorite) {
        if (!currentRoomId) {
          showFeedbackToast("Selecione uma conversa.");
          return;
        }
        enviarMensagemAtual(favorite.name ?? "Lugar favorito", favorite.id);
      }

      chatShareFavoriteBtn?.addEventListener("click", () => {
        if (!currentRoomId) {
          showFeedbackToast("Selecione uma conversa.");
          return;
        }
        openFavoriteModal();
      });

      favoriteModalCloseBtn?.addEventListener("click", () => {
        closeFavoriteModal();
      });

      favoriteModalOverlay?.addEventListener("click", (event) => {
        if (event.target === favoriteModalOverlay) {
          closeFavoriteModal();
        }
      });

      // ---------       </div>
      //</div>      </div>
      //</div> (3: conta, explorar, chat) ---------
      const tabs = document.querySelectorAll(".bottom-nav .tab");
      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          const name = tab.dataset.tab;

          if (name === "explorar") {
            fecharChat();
            // se existir painel de conta, fechamos tamb√©m
            if (typeof fecharPainelConta === "function") {
              fecharPainelConta();
            }
          } else if (name === "conta") {
            fecharChat();
            // s√≥ chama se a fun√ß√£o existir (manter conta "como est√°")
            if (typeof abrirPainelConta === "function") {
              abrirPainelConta();
            } else {
              alert(
                'Aba "Conta" ainda n√£o implementada neste HTML (voc√™ pode ligar aqui com o painel de conta que j√° criamos).'
              );
            }
          } else if (name === "chat") {
            // fecha painel de conta se existir
            if (typeof fecharPainelConta === "function") {
              fecharPainelConta();
            }
            abrirChat();
          }
        });
      });

      // ============ Amigos ‚Äì elementos da UI ============

      const friendsListEl = document.getElementById("friends-list");
      const addFriendPanelEl = document.getElementById("add-friend-panel");
      const btnOpenAddFriend = document.getElementById("btn-open-add-friend");
      const friendSearchInputEl = document.getElementById(
        "friend-search-input"
      );
      const friendSearchBtnEl = document.getElementById("friend-search-btn");
      const friendSearchResultsEl = document.getElementById(
        "friend-search-results"
      );

      // Prote√ß√£o: se for outra p√°gina sem account-panel, n√£o faz nada
      function hasFriendsUI() {
        return (
          friendsListEl &&
          addFriendPanelEl &&
          btnOpenAddFriend &&
          friendSearchInputEl &&
          friendSearchBtnEl &&
          friendSearchResultsEl
        );
      }

      // ============ Abrir/fechar painel "Adicionar amigos" ============

      if (hasFriendsUI()) {
        btnOpenAddFriend.addEventListener("click", () => {
          const isHidden = addFriendPanelEl.classList.contains("hidden");
          if (isHidden) {
            addFriendPanelEl.classList.remove("hidden");
            friendSearchInputEl.focus();
          } else {
            addFriendPanelEl.classList.add("hidden");
          }
        });

        friendSearchBtnEl.addEventListener("click", () => {
          const q = friendSearchInputEl.value.trim();
          if (!q) return;
          searchFriends(q);
        });

        friendSearchInputEl.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            friendSearchBtnEl.click();
          }
        });
      }

      // ============ Carregar overview de amigos ============

      async function loadFriendsOverview() {
        if (!hasFriendsUI()) return;

        try {
          const resp = await fetch("/api/friends");
          if (!resp.ok) {
            console.error("Erro ao carregar amigos:", resp.status);
            if (resp.status === 401 || resp.status === 403) {
              alert("Sess√£o expirada. Fa√ßa login novamente.");
              window.location.href = "/";
            }
            return;
          }

          const data = await resp.json();
          // data.friends √© uma lista de UserSummaryDTO
          renderFriendsList(data.friends || []);
        } catch (err) {
          console.error("Erro ao carregar overview de amigos:", err);
        }
      }

      function renderFriendsList(friends) {
        if (!friendsListEl) return;

        if (!friends.length) {
          friendsListEl.innerHTML =
            '<p style="font-size:0.75rem;color:#9ca3af;">Voc√™ ainda n√£o tem amigos adicionados.</p>';
          return;
        }

        friendsListEl.innerHTML = "";
        friends.forEach((f) => {
          const row = document.createElement("div");
          row.className = "friend-row";

          const left = document.createElement("div");
          left.className = "friend-left";

          const avatar = document.createElement("div");
          avatar.className = "friend-avatar";
          avatar.textContent = (f.nome || "?").charAt(0).toUpperCase();

          const info = document.createElement("div");
          const nameEl = document.createElement("div");
          nameEl.className = "friend-name";
          nameEl.textContent = f.nome;

          const emailEl = document.createElement("div");
          emailEl.className = "friend-email";
          emailEl.textContent = f.email;

          info.appendChild(nameEl);
          info.appendChild(emailEl);

          left.appendChild(avatar);
          left.appendChild(info);

          const right = document.createElement("div");
          right.className = "friend-right";
          const btn = document.createElement("button");
          btn.className = "friend-btn-danger";
          btn.textContent = "Remover";
          btn.addEventListener('click', () => {
            if (confirm(`Tem certeza que quer remover ${f.nome} da sua lista de amigos? A conversa entre voc√™s ser√° apagada.`)) {
                removerAmigo(f.id);
            }
          });

          right.appendChild(btn);

          row.appendChild(left);
          row.appendChild(right);

          friendsListEl.appendChild(row);
        });
      }

      // ============ Busca de usu√°rios para adicionar ============

      async function searchFriends(query) {
        if (!hasFriendsUI()) return;

        try {
          const resp = await fetch(
            "/api/friends/search?query=" + encodeURIComponent(query)
          );
          if (!resp.ok) {
            console.error("Erro ao buscar usu√°rios:", resp.status);
            if (resp.status === 401 || resp.status === 403) {
              alert("Sess√£o expirada. Fa√ßa login novamente.");
              window.location.href = "/";
            }
            return;
          }

          const results = await resp.json();
          renderFriendSearchResults(results);
        } catch (err) {
          console.error("Erro na busca de amigos:", err);
        }
      }

      function renderFriendSearchResults(users) {
        if (!friendSearchResultsEl) return;

        friendSearchResultsEl.innerHTML = "";

        if (!users.length) {
          friendSearchResultsEl.innerHTML =
            '<p style="font-size:0.75rem;color:#9ca3af;">Nenhum usu√°rio encontrado.</p>';
          return;
        }

        users.forEach((u) => {
          const row = document.createElement("div");
          row.className = "friend-row";

          const left = document.createElement("div");
          left.className = "friend-left";

          const avatar = document.createElement("div");
          avatar.className = "friend-avatar";
          avatar.textContent = (u.nome || "?").charAt(0).toUpperCase();

          const info = document.createElement("div");
          const nameEl = document.createElement("div");
          nameEl.className = "friend-name";
          nameEl.textContent = u.nome;

          const emailEl = document.createElement("div");
          emailEl.className = "friend-email";
          emailEl.textContent = u.email;

          info.appendChild(nameEl);
          info.appendChild(emailEl);

          left.appendChild(avatar);
          left.appendChild(info);

          const right = document.createElement("div");
          right.className = "friend-right";
          const btn = document.createElement("button");

          const status = u.status; // NONE, FRIEND, PENDING_SENT, PENDING_RECEIVED, REJECTED

          if (status === "NONE" || status === "REJECTED") {
            btn.className = "friend-btn-primary";
            btn.textContent =
              status === "REJECTED" ? "Enviar novamente" : "Enviar pedido";
            btn.addEventListener("click", () => sendFriendRequest(u.id));
          } else if (status === "FRIEND") {
            btn.className = "friend-btn-disabled";
            btn.textContent = "Amigo";
            btn.disabled = true;
          } else if (status === "PENDING_SENT") {
            btn.className = "friend-btn-disabled";
            btn.textContent = "Pendente";
            btn.disabled = true;
          } else if (status === "PENDING_RECEIVED") {
            btn.className = "friend-btn-disabled";
            btn.textContent = "Pedido recebido";
            btn.disabled = true;
          } else {
            // fallback
            btn.className = "friend-btn-disabled";
            btn.textContent = "Indefinido";
            btn.disabled = true;
          }

          right.appendChild(btn);
          row.appendChild(left);
          row.appendChild(right);

          friendSearchResultsEl.appendChild(row);
        });
      }

      // ============ Enviar pedido de amizade ============

      async function sendFriendRequest(userId) {
        try {
          const resp = await fetch("/api/friends/requests", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ targetUserId: userId }),
          });

          if (!resp.ok) {
            const text = await resp.text();
            alert("Erro ao enviar pedido: " + text);
            return;
          }

          // Atualiza lista de amigos e resultados da busca
          const q = friendSearchInputEl?.value?.trim();
          if (q) {
            searchFriends(q);
          }
          loadFriendsOverview();
        } catch (err) {
          console.error("Erro ao enviar pedido de amizade:", err);
        }
      }

      async function removerAmigo(friendId) {
        try {
            const resp = await fetch(`/api/friends/${friendId}`, {
                method: 'DELETE'
            });

            if (!resp.ok) {
                const text = await resp.text();
                showFeedbackToast(text || 'N√£o foi poss√≠vel remover amigo.');
                return;
            }

            showFeedbackToast('Amizade desfeita.');
            await loadFriendsOverview();
            await fetchChatRooms();

        } catch (err) {
            console.error("Erro ao remover amigo:", err);
            showFeedbackToast('Erro de rede ao remover amigo.');
        }
      }

      async function respondFriendRequest(requestId, accept) {
        const action = accept ? "accept" : "reject";
        const resp = await fetch(`/api/friends/requests/${requestId}/${action}`, {
          method: "POST",
        });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || "N√£o foi poss√≠vel responder ao pedido.");
        }
        await loadFriendsOverview();
      }

      function createFriendRequestToast(request) {
        if (!friendRequestToastsEl) return;

        const card = document.createElement("div");
        card.className = "toast-card";
        card.dataset.requestId = request.id;

        const message = document.createElement("p");
        message.textContent = `${request.requester.nome ?? "Um usu√°rio"} te enviou um pedido de amizade.`;

        const actions = document.createElement("div");
        actions.className = "toast-actions";

        const acceptBtn = document.createElement("button");
        acceptBtn.className = "accept";
        acceptBtn.textContent = "Aceitar";

        const rejectBtn = document.createElement("button");
        rejectBtn.className = "reject";
        rejectBtn.textContent = "Recusar";

        const handleAction = async (accept) => {
          acceptBtn.disabled = true;
          rejectBtn.disabled = true;
          try {
            await respondFriendRequest(request.id, accept);
            card.remove();
          } catch (err) {
            console.error("Erro ao responder pedido:", err);
            alert(err.message || "Erro ao responder pedido.");
            acceptBtn.disabled = false;
            rejectBtn.disabled = false;
          }
        };

        acceptBtn.addEventListener("click", () => handleAction(true));
        rejectBtn.addEventListener("click", () => handleAction(false));

        actions.appendChild(acceptBtn);
        actions.appendChild(rejectBtn);
        card.appendChild(message);
        card.appendChild(actions);
        friendRequestToastsEl.appendChild(card);
      }

      async function pollFriendRequestToasts() {
        if (!friendRequestToastsEl) return;
        try {
          const resp = await fetch("/api/friends/requests/incoming");
          if (!resp.ok) {
            return;
          }
          const data = await resp.json();
          data.forEach((request) => {
            if (!displayedFriendRequestToastIds.has(request.id)) {
              displayedFriendRequestToastIds.add(request.id);
              createFriendRequestToast(request);
            }
          });
        } catch (err) {
          console.error("Erro ao buscar pedidos pendentes:", err);
        }
      }

      if (friendRequestToastsEl) {
        pollFriendRequestToasts();
        setInterval(pollFriendRequestToasts, 15000);
      }

      loadFavoritePlacesCache();
    </script>
  </body>
</html>
