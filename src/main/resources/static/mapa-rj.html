<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Mapa do Rio de Janeiro</title>

    <!-- CSS do Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #020617;
        color: #e5e7eb;
      }

      .app-header {
        padding: 8px 12px;
        background: #020617;
        border-bottom: 1px solid #111827;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
      }

      .app-header .title {
        font-weight: 600;
      }

      .app-header .user {
        font-size: 0.8rem;
        color: #9ca3af;
      }

      #coords {
        position: absolute;
        top: 44px;
        left: 8px;
        background: rgba(15, 23, 42, 0.85);
        color: #e5e7eb;
        padding: 6px 8px;
        border-radius: 8px;
        font-size: 0.75rem;
        z-index: 1000;
      }

      #map {
        flex: 1;
        width: 100vw;
      }

      .bottom-nav {
        height: 56px;
        background: #020617;
        border-top: 1px solid #111827;
        display: flex;
        justify-content: space-around;
        align-items: center;
      }

      .bottom-nav button {
        flex: 1;
        height: 100%;
        border: none;
        background: transparent;
        color: #9ca3af;
        font-size: 0.75rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
        cursor: pointer;
      }

      .bottom-nav button span.icon {
        font-size: 1.1rem;
      }

      .bottom-nav button.active {
        color: #3b82f6;
        border-top: 2px solid #3b82f6;
      }

      @media (max-width: 480px) {
        .app-header {
          font-size: 0.8rem;
        }
        #coords {
          font-size: 0.7rem;
        }
      }

      /* Bot√£o customizado para o Leaflet */
      .leaflet-control-custom {
        background-color: white;
        border: 2px solid rgba(0, 0, 0, 0.2);
        background-clip: padding-box;
        border-radius: 4px;
        width: 34px !important;
        height: 34px !important;
        text-align: center;
        line-height: 30px;
        font-size: 1.2rem;
        cursor: pointer;
      }

      /* √çcone de c√≠rculo azul para a localiza√ß√£o real do usu√°rio */
      .blue-circle-icon div {
        width: 16px;
        height: 16px;
        background-color: #3b82f6;
        border: 2px solid #1d4ed8;
        border-radius: 50%;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="title">JaVai</div>
      <div class="user">Online</div>
    </header>

    <div id="coords">Localiza√ß√£o: carregando...</div>

    <div id="map"></div>

    <div id="account-panel" class="account-panel" style="display: none">
      <div class="account-panel-header">
        <h3>Sua conta</h3>
        <button
          class="account-panel-close"
          id="close-account-panel"
          aria-label="Fechar"
        >
          ‚úï
        </button>
      </div>
      <div id="account-content">
        <small>Carregando informa√ß√µes...</small>
      </div>
    </div>

    <nav class="bottom-nav">
      <button class="tab" data-tab="historico">
        <span class="icon">üïí</span>
        <span>Hist√≥rico</span>
      </button>
      <button class="tab" data-tab="grupos">
        <span class="icon">üë•</span>
        <span>Grupos</span>
      </button>
      <button class="tab active" data-tab="explorar">
        <span class="icon">üß≠</span>
        <span>Explorar</span>
      </button>
      <button class="tab" data-tab="recomendacoes">
        <span class="icon">‚ú®</span>
        <span>Recomenda√ß√µes</span>
      </button>
      <button class="tab" data-tab="conta">
        <span class="icon">‚öôÔ∏è</span>
        <span>Conta</span>
      </button>
    </nav>

    <!-- JS do Leaflet -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // --------- Elementos da UI ---------
      const coordsDiv = document.getElementById("coords");

      // --------- Estado da Aplica√ß√£o ---------
      let userActualLocation = null; // Localiza√ß√£o REAL do usu√°rio (do GPS)
      const defaultLat = -22.9068;
      const defaultLon = -43.1729;
      const defaultRadius = 1000;

      // --------- Inicializa√ß√£o do Mapa (Leaflet) ---------
      const map = L.map("map", { zoomControl: false }).setView(
        [defaultLat, defaultLon],
        12
      );
      L.control.zoom({ position: "topright" }).addTo(map);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      const markersLayer = L.layerGroup().addTo(map);

      // --------- √çcones e Marcadores ---------
      const userIcon = L.icon({
        iconUrl:
          "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
        shadowUrl:
          "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41],
      });

      const blueCircleIcon = L.divIcon({
        className: "blue-circle-icon",
        html: "<div></div>",
        iconSize: [16, 16],
        iconAnchor: [8, 8],
      });

      // üìå Pino vermelho (marcador de busca), m√≥vel
      let searchMarker = null;
      // üîµ C√≠rculo azul (localiza√ß√£o real), agora como um marcador est√°tico
      let locationMarker = null;

      // --------- Controle Customizado "Home" ---------
      const HomeButton = L.Control.extend({
        options: {
          position: "topright",
        },
        onAdd: function (map) {
          const btn = L.DomUtil.create(
            "div",
            "leaflet-bar leaflet-control leaflet-control-custom"
          );
          btn.innerHTML = "üè†";

          L.DomEvent.on(btn, "click", function (e) {
            L.DomEvent.stop(e); // Impede que o clique chegue no mapa

            if (userActualLocation) {
              map.setView(userActualLocation, 14);
              setSearchMarker(
                userActualLocation.lat,
                userActualLocation.lng,
                "Buscando a partir da sua localiza√ß√£o"
              );
              carregarPlaces(userActualLocation.lat, userActualLocation.lng);
            } else {
              alert(
                "Ainda n√£o foi poss√≠vel obter sua localiza√ß√£o inicial. Tente recarregar a p√°gina."
              );
            }
          });
          return btn;
        },
      });
      map.addControl(new HomeButton());

      // --------- L√≥gica de Eventos ---------
      map.on("click", function (e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;
        console.log("Posi√ß√£o de busca ajustada manualmente:", lat, lon);
        setSearchMarker(lat, lon, "Buscando a partir daqui");
        carregarPlaces(lat, lon, defaultRadius);
      });

      // --------- Fun√ß√µes Auxiliares ---------
      const accountPanel = document.getElementById("account-panel");
      const accountContent = document.getElementById("account-content");
      const closeAccountBtn = document.getElementById("close-account-panel");

      async function abrirPainelConta() {
        accountPanel.style.display = "block";
        accountContent.innerHTML = "<small>Carregando informa√ß√µes...</small>";

        try {
          const resp = await fetch("/api/me");
          if (!resp.ok) {
            accountContent.innerHTML = `<p>N√£o foi poss√≠vel carregar seus dados (${resp.status}).</p>`;
            return;
          }

          const user = await resp.json();

          // üëá sem a frase "Esses dados v√™m do usu√°rio..."
          accountContent.innerHTML = `
      <p><strong>Nome:</strong><br/>${user.nome ?? "‚Äî"}</p>
      <p><strong>Email:</strong><br/>${user.email ?? "‚Äî"}</p>
      <p><strong>ID interno:</strong><br/><code>${user.id}</code></p>
    `;
        } catch (e) {
          console.error("Erro ao carregar /api/me:", e);
          accountContent.innerHTML =
            "<p>Ocorreu um erro ao carregar suas informa√ß√µes. Tente novamente mais tarde.</p>";
        }
      }

      function fecharPainelConta() {
        accountPanel.style.display = "none";
      }

      // bot√£o X fecha sempre
      closeAccountBtn.addEventListener("click", () => {
        fecharPainelConta();
      });

      function atualizarCoordsLabel(texto) {
        coordsDiv.textContent = texto;
      }

      // Define a posi√ß√£o do PINO VERMELHO de busca
      function setSearchMarker(lat, lon, label) {
        console.log("Pino de busca movido para:", lat, lon, "‚Üí", label);
        atualizarCoordsLabel(
          `Buscando em: ${lat.toFixed(5)}, ${lon.toFixed(5)}`
        );

        if (searchMarker) {
          searchMarker.setLatLng([lat, lon]);
          searchMarker.setPopupContent(label);
        } else {
          searchMarker = L.marker([lat, lon], { icon: userIcon })
            .addTo(map)
            .bindPopup(label)
            .openPopup();
        }
      }

      async function carregarPlaces(lat, lon, radius = defaultRadius) {
        try {
          const url = `/api/places?lat=${lat}&lon=${lon}&radius=${radius}`;
          console.log("Chamando:", url);
          const response = await fetch(url);
          if (!response.ok) {
            console.error("Erro ao chamar /api/places:", response.status);
            if (response.status === 401 || response.status === 403) {
              alert("Sess√£o expirada. Por favor, fa√ßa login novamente.");
              window.location.href = "/";
            }
            return;
          }
          const places = await response.json();
          markersLayer.clearLayers();
          places.forEach((place) => {
            const marker = L.marker([place.lat, place.lon]).addTo(markersLayer);
            marker.bindPopup(
              `<b>${place.name}</b><br/>Tipo: ${place.type}<br/><button onclick="combinarRole(${place.id})">Combinar rol√™</button>`
            );
          });
        } catch (error) {
          console.error("Erro ao carregar places:", error);
        }
      }

      function combinarRole(placeId) {
        alert(
          "Combinar rol√™ no lugar ID " +
            placeId +
            " (futuro: abrir fluxo de grupo/vota√ß√£o)"
        );
      }

      function carregarPosicaoPadrao(motivo) {
        console.warn(motivo);
        map.setView([defaultLat, defaultLon], 12);
        setSearchMarker(defaultLat, defaultLon, "Local padr√£o: Centro do Rio");
        carregarPlaces(defaultLat, defaultLon, defaultRadius);
      }

      // --------- Fun√ß√£o Principal de Inicializa√ß√£o ---------
      async function inicializarMapa() {
        if (!navigator.geolocation) {
          carregarPosicaoPadrao("Geolocaliza√ß√£o n√£o suportada no navegador.");
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            // Sucesso ao obter localiza√ß√£o
            const userLat = pos.coords.latitude;
            const userLon = pos.coords.longitude;
            userActualLocation = { lat: userLat, lng: userLon };

            map.setView([userLat, userLon], 14);

            // Adiciona o marcador azul est√°tico da localiza√ß√£o real
            if (locationMarker) locationMarker.remove();
            locationMarker = L.marker([userLat, userLon], {
              icon: blueCircleIcon,
              zIndexOffset: -100, // Garante que fique "atr√°s" do pino vermelho se sobreposto
            }).addTo(map);

            // Posiciona o pino de busca inicial na localiza√ß√£o do usu√°rio
            setSearchMarker(
              userLat,
              userLon,
              "Buscando a partir da sua localiza√ß√£o"
            );
            carregarPlaces(userLat, userLon, defaultRadius);
          },
          (err) => {
            // Erro ao obter localiza√ß√£o
            atualizarCoordsLabel("N√£o foi poss√≠vel obter sua localiza√ß√£o.");
            carregarPosicaoPadrao(`Erro ao obter localiza√ß√£o: ${err.message}`);
          },
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
        );
      }

      // Inicia tudo
      inicializarMapa();

      const tabs = document.querySelectorAll(".bottom-nav .tab");

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");

          const name = tab.dataset.tab;

          if (name === "conta") {
            abrirPainelConta();
          } else {
            fecharPainelConta(); // üëà garante que a aba Conta some

            if (name !== "explorar") {
              alert(
                'Aba "' +
                  name +
                  '" ainda n√£o implementada. Aqui depois entra a tela de ' +
                  name +
                  "."
              );
            }
          }
        });
      });
    </script>
  </body>
</html>
