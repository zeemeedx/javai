<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Mapa do Rio de Janeiro</title>

    <!-- CSS do Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100vh;
        width: 100vw;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!-- JS do Leaflet -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // Centro padrão (Rio de Janeiro)
      const defaultLat = -22.9068;
      const defaultLon = -43.1729;
      const defaultRadius = 2000;

      const map = L.map("map").setView([defaultLat, defaultLon], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      const markersLayer = L.layerGroup().addTo(map);

      async function carregarPlaces(lat, lon, radius = defaultRadius) {
        try {
          const url = `/api/places?lat=${lat}&lon=${lon}&radius=${radius}`;
          console.log("Chamando:", url);

          const response = await fetch(url);
          if (!response.ok) {
            console.error("Erro ao chamar /api/places:", response.status);
            return;
          }

          const places = await response.json();
          console.log("Places recebidos:", places.length, places);

          markersLayer.clearLayers();

          if (!places.length) {
            console.warn("Nenhum place recebido da API");
            return;
          }

          places.forEach((place) => {
            const marker = L.marker([place.lat, place.lon]).addTo(markersLayer);
            marker.bindPopup(`
            <b>${place.name}</b><br/>
            Tipo: ${place.type}<br/>
            <button onclick="combinarRole(${place.id})">
                Combinar rolê
            </button>
            `);
          });
        } catch (error) {
          console.error("Erro ao carregar places:", error);
        }
      }

      function combinarRole(placeId) {
        alert("Combinar rolê no lugar ID " + placeId);
      }

      function inicializarMapa() {
        // Primeiro tenta GPS
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const userLat = pos.coords.latitude;
              const userLon = pos.coords.longitude;
              console.log("Localização do usuário:", userLat, userLon);

              map.setView([userLat, userLon], 13);
              carregarPlaces(userLat, userLon, defaultRadius);
            },
            (err) => {
              console.warn(
                "Não foi possível obter localização do usuário:",
                err.message
              );
              // fallback: usa Rio de Janeiro
              map.setView([defaultLat, defaultLon], 12);
              carregarPlaces(defaultLat, defaultLon, defaultRadius);
            },
            {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0,
            }
          );
        } else {
          console.warn("Geolocalização não suportada no navegador");
          // fallback: Rio
          carregarPlaces(defaultLat, defaultLon, defaultRadius);
        }
      }

      // inicia tudo
      inicializarMapa();
    </script>
  </body>
</html>
