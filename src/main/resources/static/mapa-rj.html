<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Mapa do Rio de Janeiro</title>

    <!-- CSS do Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      :root {
        --panel-bg: rgba(15, 23, 42, 0.85);
        --main-text: #e5e7eb;
        --border-color: #111827;
        --blue: #3b82f6;
        --dark-blue: #1d4ed8;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #020617;
        color: var(--main-text);
      }

      .app-header {
        padding: 8px 12px;
        background: #020617;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1001; /* Acima dos paineis */
      }

      .app-header .title { font-weight: 600; }
      .app-header .user { font-size: 0.8rem; color: #9ca3af; }

      #map {
        flex: 1;
        width: 100vw;
      }

      /* Painel de Coordenadas (movido para baixo) */
      #coords {
        position: absolute;
        bottom: 64px; /* Acima da barra de navega√ß√£o */
        left: 8px;
        background: var(--panel-bg);
        padding: 6px 8px;
        border-radius: 8px;
        font-size: 0.75rem;
        z-index: 1000;
        max-width: 300px;
      }

      /* Painel de Filtro de Categorias */
      #category-filter {
        position: absolute;
        top: 44px;
        left: 8px;
        background: var(--panel-bg);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        z-index: 1000;
        max-height: 50vh;
        max-width: 200px;
        overflow-y: auto;
      }
      #category-filter h4 {
        margin: 0 0 8px 0;
        font-size: 0.85rem;
        border-bottom: 1px solid #334155;
        padding-bottom: 4px;
      }
      .category-item {
        display: block;
        margin-bottom: 5px;
      }
      .category-item label {
        cursor: pointer;
        user-select: none;
        margin-left: 4px;
      }
      .category-item input {
        cursor: pointer;
      }

      /* Loader para categorias */
      .loader {
        font-size: 0.75rem;
        color: #9ca3af;
      }

      .bottom-nav {
        height: 56px;
        background: #020617;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-around;
        align-items: center;
      }
      /* ... (regras da bottom-nav e media query mantidas) ... */
      .bottom-nav button { flex: 1; height: 100%; border: none; background: transparent; color: #9ca3af; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; cursor: pointer; }
      .bottom-nav button span.icon { font-size: 1.1rem; }
      .bottom-nav button.active { color: var(--blue); border-top: 2px solid var(--blue); }

      @media (max-width: 480px) {
        .app-header { font-size: 0.8rem; }
        #coords { font-size: 0.7rem; bottom: 60px; }
        #category-filter { font-size: 0.75rem; padding: 6px 8px; }
      }

      /* Bot√£o customizado para o Leaflet */
      .leaflet-control-custom {
        background-color: white;
        border: 2px solid rgba(0,0,0,0.2);
        background-clip: padding-box;
        border-radius: 4px;
        width: 34px !important;
        height: 34px !important;
        text-align: center;
        line-height: 30px;
        font-size: 1.2rem;
        cursor: pointer;
      }
      
      /* √çcone de c√≠rculo azul para a localiza√ß√£o real do usu√°rio */
      .blue-circle-icon div {
        width: 16px;
        height: 16px;
        background-color: var(--blue);
        border: 2px solid var(--dark-blue);
        border-radius: 50%;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="title">JaVai</div>
      <div class="user">Online</div>
    </header>

    <div id="category-filter"></div>
    <div id="coords">Localiza√ß√£o: carregando...</div>

    <div id="map"></div>

    <nav class="bottom-nav">
      <button class="tab" data-tab="historico">
        <span class="icon">üïí</span>
        <span>Hist√≥rico</span>
      </button>
      <button class="tab" data-tab="grupos">
        <span class="icon">üë•</span>
        <span>Grupos</span>
      </button>
      <button class="tab active" data-tab="explorar">
        <span class="icon">üß≠</span>
        <span>Explorar</span>
      </button>
      <button class="tab" data-tab="recomendacoes">
        <span class="icon">‚ú®</span>
        <span>Recomenda√ß√µes</span>
      </button>
      <button class="tab" data-tab="conta">
        <span class="icon">‚öôÔ∏è</span>
        <span>Conta</span>
      </button>
    </nav>

    <!-- JS do Leaflet -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="js/traducoes.js" defer></script>

    <script>
      // --------- Elementos da UI ---------
      const coordsDiv = document.getElementById("coords");
      const categoryFilterDiv = document.getElementById("category-filter");

      // --------- Estado da Aplica√ß√£o ---------
      let userActualLocation = null;
      let currentSearchCoords = null;
      let allFoundPlaces = [];
      const defaultLat = -22.9068;
      const defaultLon = -43.1729;
      const defaultRadius = 1500;
      const defaultCheckedCategories = new Set([
        'place_of_worship', 'restaurant', 'fast_food', 'cafe', 'bar',
        'ice_cream', 'pub', 'cinema', 'theatre', 'nightclub', 'university'
      ]);

      // Estilo para o c√≠rculo de raio
      const radiusCircleOptions = {
        color: '#000000',
        weight: 2,
        opacity: 1,
        fill: false,
        dashArray: '5, 10'
      };

      // --------- Inicializa√ß√£o do Mapa (Leaflet) ---------
      const map = L.map("map", { zoomControl: false }).setView([defaultLat, defaultLon], 12);
      L.control.zoom({ position: "topright" }).addTo(map);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution: "&copy; OpenStreetMap contributors" }).addTo(map);
      const markersLayer = L.layerGroup().addTo(map);

      // --------- √çcones e Marcadores ---------
      const userIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
      const blueCircleIcon = L.divIcon({ className: 'blue-circle-icon', html: '<div></div>', iconSize: [16, 16], iconAnchor: [8, 8] });
      let searchMarker = null;
      let locationMarker = null;
      let searchRadiusCircle = null; // C√≠rculo pontilhado do raio

      // --------- Controle Customizado "Home" ---------
      const HomeButton = L.Control.extend({
        options: { position: 'topright' },
        onAdd: function (map) {
          const btn = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
          btn.innerHTML = 'üè†';
          L.DomEvent.on(btn, 'click', (e) => {
            L.DomEvent.stop(e);
            if (userActualLocation) {
              map.setView([userActualLocation.lat, userActualLocation.lng], 14);
              setSearchMarker(userActualLocation.lat, userActualLocation.lng, "Buscando a partir da sua localiza√ß√£o");
            } else {
              alert("Ainda n√£o foi poss√≠vel obter sua localiza√ß√£o inicial. Tente recarregar a p√°gina.");
            }
          });
          return btn;
        }
      });
      map.addControl(new HomeButton());

      // --------- L√≥gica de Eventos ---------
      map.on("click", function (e) {
        const { lat, lng } = e.latlng;
        setSearchMarker(lat, lng, "Buscando a partir daqui");
      });

      categoryFilterDiv.addEventListener('change', () => {
        aplicarFiltroEAtualizarMapa();
      });

      // --------- Fun√ß√µes Principais da L√≥gica de Filtragem ---------
      function setSearchMarker(lat, lon, label) {
        currentSearchCoords = { lat, lon };
        atualizarCoordsLabel(`Buscando em: ${lat.toFixed(5)}, ${lon.toFixed(5)}`);
        
        if (searchMarker) {
          searchMarker.setLatLng([lat, lon]);
          searchMarker.setPopupContent(label);
        } else {
          searchMarker = L.marker([lat, lon], { icon: userIcon }).addTo(map).bindPopup(label).openPopup();
        }

        // Desenha ou move o c√≠rculo de raio
        if (searchRadiusCircle) {
          searchRadiusCircle.setLatLng([lat, lon]);
        } else {
          searchRadiusCircle = L.circle([lat, lon], { ...radiusCircleOptions, radius: defaultRadius }).addTo(map);
        }

        carregarPlaces();
      }

      async function carregarPlaces() {
        if (!currentSearchCoords) return;
        categoryFilterDiv.innerHTML = '<span class="loader">Buscando locais...</span>';
          markersLayer.clearLayers();
        const { lat, lon } = currentSearchCoords;
        try {
          const url = `/api/places?lat=${lat}&lon=${lon}&radius=${defaultRadius}`;
          const response = await fetch(url);
          if (!response.ok) {
            categoryFilterDiv.innerHTML = '<span class="loader">Erro na busca.</span>';
            if (response.status === 401 || response.status === 403) {
              alert("Sess√£o expirada. Por favor, fa√ßa login novamente.");
              window.location.href = "/";
            }
            return;
          }
          allFoundPlaces = await response.json();
          atualizarFiltroCategorias(allFoundPlaces);
          aplicarFiltroEAtualizarMapa();
        } catch (error) {
          console.error("Erro ao carregar places:", error);
          categoryFilterDiv.innerHTML = '<span class="loader">Erro na busca.</span>';
        }
      }

      function atualizarFiltroCategorias(places) {
        if (places.length === 0) {
          categoryFilterDiv.innerHTML = '<span class="loader">Nenhum local encontrado.</span>';
          return;
        }
        const categories = [...new Set(places.map(p => p.type))].sort();
        categoryFilterDiv.innerHTML = '<h4>Categorias</h4>';
        categories.forEach(cat => {
          const id = `cat-${cat}`;
          const item = document.createElement('div');
          item.className = 'category-item';
          const labelTraduzida = traducoes[cat] || cat.replace(/_/g, ' ');
          const isChecked = defaultCheckedCategories.has(cat) ? 'checked' : '';
          item.innerHTML = `
            <input type="checkbox" id="${id}" value="${cat}" ${isChecked}>
            <label for="${id}">${labelTraduzida}</label>
          `;
          categoryFilterDiv.appendChild(item);
        });
      }

      function aplicarFiltroEAtualizarMapa() {
        const selectedCategories = new Set(
          Array.from(categoryFilterDiv.querySelectorAll('input:checked')).map(input => input.value)
        );
        const placesFiltrados = allFoundPlaces.filter(place => selectedCategories.has(place.type));
        markersLayer.clearLayers();
        placesFiltrados.forEach((place) => {
          const marker = L.marker([place.lat, place.lon]).addTo(markersLayer);
          const tipoTraduzido = traducoes[place.type] || place.type.replace(/_/g, ' ');
          marker.bindPopup(`<b>${place.name}</b><br/>Tipo: ${tipoTraduzido}<br/><button onclick="combinarRole(${place.id})">Combinar rol√™</button>`);
        });
      }

      // --------- Fun√ß√µes Auxiliares ---------
      function atualizarCoordsLabel(texto) { coordsDiv.textContent = texto; }
      function combinarRole(placeId) { alert("Combinar rol√™ no lugar ID " + placeId + " (futuro: abrir fluxo de grupo/vota√ß√£o)"); }

      function carregarPosicaoPadrao(motivo) {
        console.warn(motivo);
        map.setView([defaultLat, defaultLon], 12);
        setSearchMarker(defaultLat, defaultLon, "Local padr√£o: Centro do Rio");
      }

      // --------- Fun√ß√£o Principal de Inicializa√ß√£o ---------
      async function inicializarMapa() {
        categoryFilterDiv.innerHTML = '<span class="loader">Mova o pino para buscar...</span>';
        if (!navigator.geolocation) {
          carregarPosicaoPadrao("Geolocaliza√ß√£o n√£o suportada no navegador.");
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const userLat = pos.coords.latitude;
            const userLon = pos.coords.longitude;
            userActualLocation = { lat: userLat, lng: userLon };
            map.setView([userLat, userLon], 14);
            if (locationMarker) locationMarker.remove();
            locationMarker = L.marker([userLat, userLon], { icon: blueCircleIcon, zIndexOffset: -100 }).addTo(map);
            setSearchMarker(userLat, userLon, "Buscando a partir da sua localiza√ß√£o");
          },
          (err) => {
            atualizarCoordsLabel("N√£o foi poss√≠vel obter sua localiza√ß√£o.");
            carregarPosicaoPadrao(`Erro ao obter localiza√ß√£o: ${err.message}`);
          },
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
        );
      }

      // Inicia tudo
      inicializarMapa();

      // Tabs (l√≥gica original mantida)
      const tabs = document.querySelectorAll(".bottom-nav .tab");
      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          const name = tab.dataset.tab;
          if (name !== "explorar") {
            alert('Aba "' + name + '" ainda n√£o implementada.');
          }
        });
      });
    </script>
  </body>
</html>
