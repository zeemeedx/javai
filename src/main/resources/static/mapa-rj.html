<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Mapa do Rio de Janeiro</title>

  <!-- CSS do Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- JS do Leaflet -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // Centro aproximado do Rio
    const rioLat = -22.9068;
    const rioLon = -43.1729;

    // Inicializa o mapa
    const map = L.map('map').setView([rioLat, rioLon], 12);

    // Camada de tiles do OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Camada para agrupar os marcadores
    const markersLayer = L.layerGroup().addTo(map);

    async function carregarPlaces() {
      try {
        const response = await fetch('/api/places');
        if (!response.ok) {
          console.error('Erro ao chamar /api/places:', response.status);
          return;
        }

        const places = await response.json();
        console.log('Places recebidos:', places.length, places);
        if (!places.length) {
        console.warn('Nenhum place recebido da API');
        }

        markersLayer.clearLayers();

        places.forEach(place => {
          const marker = L.marker([place.lat, place.lon]).addTo(markersLayer);
          marker.bindPopup(`
            <b>${place.name}</b><br/>
            Tipo: ${place.type}<br/>
            <button onclick="combinarRole(${place.id})">
              Combinar rolê
            </button>
          `);
        });

      } catch (error) {
        console.error('Erro ao carregar places:', error);
      }
    }

    function combinarRole(placeId) {
      // aqui depois vocês integram com o fluxo de criar evento / chat etc.
      alert('Combinar rolê no lugar ID ' + placeId);
    }

    // Chama ao carregar a página
    carregarPlaces();
  </script>
</body>
</html>
